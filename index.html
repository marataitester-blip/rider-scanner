<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIDER WAITE SCANNER</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #0f0f0f; overflow: hidden; font-family: 'Roboto', sans-serif; color: #e0c097; }
        #container { position: relative; width: 100vw; height: 100vh; }
        
        video#input-video { width: 100%; height: 100%; object-fit: cover; display: none; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° (–¢–≤–æ–π —Å—Ç–∏–ª—å –æ—Ç –ê—É—Ä—ã-3, –Ω–æ —Ü–≤–µ—Ç–∞ —á—É—Ç—å —Å—Ç—Ä–æ–∂–µ –ø–æ–¥ –†–∞–π–¥–µ—Ä–∞) */
        .ui-layer { position: absolute; top:0; left:0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        .top-panel { background: rgba(0,0,0,0.85); padding: 15px; pointer-events: auto; border-bottom: 2px solid #e0c097; display: flex; flex-direction: column; gap: 10px; }
        input[type="text"] { background: rgba(255,255,255,0.1); border: 1px solid #e0c097; color: #fff; padding: 10px; border-radius: 5px; font-size: 16px; width: 90%; margin: 0 auto; }
        
        .expert-switch { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
        .expert-btn { background: #222; border: 1px solid #555; color: #888; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold; transition: 0.3s; }
        .expert-btn.active.margot { background: #5a2a4a; border-color: #ff69b4; color: #fff; box-shadow: 0 0 10px #ff69b4; }
        .expert-btn.active.messire { background: #1a2a3a; border-color: #4da6ff; color: #fff; box-shadow: 0 0 10px #4da6ff; }

        .bottom-panel { padding: 20px; pointer-events: auto; text-align: center; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
        .scan-btn { background: #e0c097; color: #000; border: none; width: 80px; height: 80px; border-radius: 50%; font-size: 34px; box-shadow: 0 0 25px rgba(224, 192, 151, 0.4); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .scan-btn:active { transform: scale(0.9); }

        #result-box { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #111; z-index: 100; display: none; pointer-events: auto;
            flex-direction: column; 
        }
        
        .result-scroll-area { flex: 1; overflow-y: auto; padding: 20px; text-align: center; }
        .cards-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px; }

        .card-item { width: 30%; min-width: 90px; max-width: 140px; display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; }
        .card-visual { width: 100%; border-radius: 6px; border: 1px solid #e0c097; box-shadow: 0 0 10px rgba(224, 192, 151, 0.2); }
        .card-name-mini { font-size: 12px; margin-top: 5px; color: #fff; text-align: center; font-family: 'Cinzel', serif; }
        .close-res { margin: 20px; padding: 15px; background: transparent; color: #e0c097; border: 1px solid #e0c097; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }

        #zoom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 200; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #zoom-title { color: #e0c097; font-family: 'Cinzel', serif; font-size: 24px; margin-bottom: 15px; }

        #start-screen {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#0f0f0f; z-index:999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; text-shadow: 0 0 10px #e0c097; transform: scale(0.98); }
            50% { opacity: 1; text-shadow: 0 0 25px #e0c097; transform: scale(1.02); }
            100% { opacity: 0.6; text-shadow: 0 0 10px #e0c097; transform: scale(0.98); }
        }

        .logo-text {
            font-family: 'Cinzel', serif; font-size: 36px; color: #e0c097;
            margin-bottom: 50px; animation: pulse 3s infinite; text-align: center; letter-spacing: 2px;
        }

        #big-start-btn {
            padding: 15px 40px; font-size: 16px; 
            background: transparent; color: #e0c097; 
            border: 1px solid #e0c097; text-transform: uppercase;
            font-family: 'Cinzel', serif; cursor: pointer;
            transition: all 0.3s;
        }
        
        .loader-spinner {
            border: 4px solid #333; border-top: 4px solid #e0c097; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin-top: 20px;
            display: none; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-text { position: absolute; bottom: 120px; width: 100%; text-align: center; font-size: 14px; text-shadow: 1px 1px 2px black; color: #ddd; background: rgba(0,0,0,0.5); padding: 5px; }
        #error-log { color: #ff5555; margin-top: 15px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="container">
        <div id="start-screen">
            <div class="logo-text">RIDER WAITE<br>SCANNER</div>
            <button id="big-start-btn" onclick="initSystem()">START SESSION</button>
            <div id="loading-spinner" class="loader-spinner"></div>
            <div id="loading-text" style="color: #666; margin-top: 10px; font-size: 12px; display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (Nano 640)...</div>
            <div id="error-log"></div>
        </div>

        <video id="input-video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
        
        <div class="ui-layer">
            <div class="top-panel">
                <input type="text" id="questionInput" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å...">
                <div class="expert-switch">
                    <div class="expert-btn active margot" onclick="setExpert('margot')">üå∏ –ú–ê–†–ì–û</div>
                    <div class="expert-btn" onclick="setExpert('messire')">‚ô†Ô∏è –ú–ï–°–°–ò–†</div>
                </div>
            </div>
            <div id="status" class="status-text">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
            <div class="bottom-panel">
                <button class="scan-btn" onclick="captureRead()">üì∑</button>
            </div>
        </div>

        <div id="result-box">
            <div class="result-scroll-area">
                <h2 id="res-header" style="color: #e0c097; font-family: 'Cinzel'; margin-bottom: 10px;">–û–¢–í–ï–¢</h2>
                <hr style="border-color: #333; width: 50%; margin: 10px auto;">
                <div id="cards-container" class="cards-row"></div>
                <div id="ai-response" style="color: #ddd; text-align: left; font-size: 14px; line-height: 1.5; background: #111; padding: 15px; border-radius: 10px; border: 1px solid #333;"></div>
            </div>
            <button class="close-res" onclick="closeResult()">–ù–û–í–´–ô –°–ö–ê–ù</button>
        </div>

        <div id="zoom-modal" onclick="closeZoom()">
            <div id="zoom-title">–ö–∞—Ä—Ç–∞</div>
            <div id="zoom-media-placeholder"></div>
            <p style="color: #777; margin-top: 20px; font-size: 12px;">(–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å)</p>
        </div>
    </div>

    <script>
        // === –ë–ê–ó–ê –î–ê–ù–ù–´–• RIDER WAITE (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å —Ç–≤–æ–µ–≥–æ GitHub) ===
        const BASE_IMG_URL = "https://raw.githubusercontent.com/marataitester-blip/rider-tarot-card/main/Cards-jpg/Cards-jpg/";
        const TAROT_DATA = [];

        try {
            // –°—Ç–∞—Ä—à–∏–µ (0-21)
            const majors = [
                {n:"–®—É—Ç", f:"00-TheFool.jpg"}, {n:"–ú–∞–≥", f:"01-TheMagician.jpg"}, {n:"–ñ—Ä–∏—Ü–∞", f:"02-TheHighPriestess.jpg"},
                {n:"–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", f:"03-TheEmpress.jpg"}, {n:"–ò–º–ø–µ—Ä–∞—Ç–æ—Ä", f:"04-TheEmperor.jpg"}, {n:"–ñ—Ä–µ—Ü", f:"05-TheHierophant.jpg"},
                {n:"–í–ª—é–±–ª–µ–Ω–Ω—ã–µ", f:"06-TheLovers.jpg"}, {n:"–ö–æ–ª–µ—Å–Ω–∏—Ü–∞", f:"07-TheChariot.jpg"}, {n:"–°–∏–ª–∞", f:"08-Strength.jpg"},
                {n:"–û—Ç—à–µ–ª—å–Ω–∏–∫", f:"09-TheHermit.jpg"}, {n:"–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", f:"10-WheelOfFortune.jpg"}, {n:"–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å", f:"11-Justice.jpg"},
                {n:"–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", f:"12-TheHangedMan.jpg"}, {n:"–°–º–µ—Ä—Ç—å", f:"13-Death.jpg"}, {n:"–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", f:"14-Temperance.jpg"},
                {n:"–î—å—è–≤–æ–ª", f:"15-TheDevil.jpg"}, {n:"–ë–∞—à–Ω—è", f:"16-TheTower.jpg"}, {n:"–ó–≤–µ–∑–¥–∞", f:"17-TheStar.jpg"},
                {n:"–õ—É–Ω–∞", f:"18-TheMoon.jpg"}, {n:"–°–æ–ª–Ω—Ü–µ", f:"19-TheSun.jpg"}, {n:"–°—É–¥", f:"20-Judgement.jpg"},
                {n:"–ú–∏—Ä", f:"21-TheWorld.jpg"}
            ];
            majors.forEach(m => TAROT_DATA.push({ name: m.n, type: 'major', image: BASE_IMG_URL + m.f }));

            // –ú–ª–∞–¥—à–∏–µ (22-77)
            const suits = [{id: 'Wands', ru: '–ñ–µ–∑–ª–æ–≤'}, {id: 'Cups', ru: '–ö—É–±–∫–æ–≤'}, {id: 'Swords', ru: '–ú–µ—á–µ–π'}, {id: 'Pentacles', ru: '–ü–µ–Ω—Ç–∞–∫–ª–µ–π'}];
            const ranks = ['–¢—É–∑', '2', '3', '4', '5', '6', '7', '8', '9', '10', '–ü–∞–∂', '–†—ã—Ü–∞—Ä—å', '–ö–æ—Ä–æ–ª–µ–≤–∞', '–ö–æ—Ä–æ–ª—å'];
            
            suits.forEach(s => {
                ranks.forEach((r, idx) => {
                    const num = (idx + 1).toString().padStart(2, '0');
                    TAROT_DATA.push({ name: `${r} ${s.ru}`, type: 'minor', image: BASE_IMG_URL + `${s.id}${num}.jpg` });
                });
            });
        } catch (e) { console.error("–û—à–∏–±–∫–∞ –±–∞–∑—ã:", e); }

        // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        let currentExpert = 'margot';
        let detectedCards = []; 
        const status = document.getElementById('status');
        
        // üî• –ù–û–í–ê–Ø –ë–´–°–¢–†–ê–Ø –ú–û–î–ï–õ–¨
        const MODEL_PATH = 'rider_smart.onnx'; 
        const MODEL_SIZE = 640; // –°–∫–æ—Ä–æ—Å—Ç—å!

        let session;

        function setExpert(name) {
            currentExpert = name;
            document.querySelectorAll('.expert-btn').forEach(b => b.classList.remove('active', 'margot', 'messire'));
            const btn = document.querySelector(`.expert-btn[onclick="setExpert('${name}')"]`);
            btn.classList.add('active', name);
        }

        ort.env.wasm.numThreads = 2; 
        ort.env.wasm.simd = false;

        async function initSystem() {
            const btn = document.getElementById('big-start-btn');
            const spinner = document.getElementById('loading-spinner');
            const loadText = document.getElementById('loading-text');
            const errorLog = document.getElementById('error-log');
            
            btn.style.display = 'none';
            spinner.style.display = 'block';
            loadText.style.display = 'block';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} }, 
                    audio: false 
                });
                
                const video = document.getElementById('input-video');
                video.srcObject = stream;
                video.style.display = 'block'; 
                await new Promise(r => video.onloadedmetadata = r);

                session = await ort.InferenceSession.create(MODEL_PATH, { executionProviders: ['wasm'] });

                const startScreen = document.getElementById('start-screen');
                startScreen.style.opacity = '0';
                setTimeout(() => { startScreen.style.display = 'none'; }, 1000);

                status.innerText = "–°–ö–ê–ù–ï–† –ì–û–¢–û–í";
                detectFrame(video);

            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: " + e.message);
                btn.style.display = 'block';
                spinner.style.display = 'none';
                btn.innerText = "–ü–û–í–¢–û–†–ò–¢–¨";
                errorLog.innerText = e.message;
            }
        }

        async function detectFrame(video) {
            const canvas = document.getElementById('canvas');
            const mat = document.createElement('canvas');
            mat.width = MODEL_SIZE; mat.height = MODEL_SIZE;
            mat.getContext('2d').drawImage(video, 0, 0, MODEL_SIZE, MODEL_SIZE);
            const data = mat.getContext('2d').getImageData(0,0,MODEL_SIZE,MODEL_SIZE).data;
            
            const input = new Float32Array(3 * MODEL_SIZE * MODEL_SIZE);
            for (let i=0; i<MODEL_SIZE*MODEL_SIZE; i++) {
                input[i] = data[i*4]/255.0;
                input[MODEL_SIZE*MODEL_SIZE+i] = data[i*4+1]/255.0;
                input[2*MODEL_SIZE*MODEL_SIZE+i] = data[i*4+2]/255.0;
            }
            const tensor = new ort.Tensor('float32', input, [1, 3, MODEL_SIZE, MODEL_SIZE]);

            try {
                const results = await session.run({ [session.inputNames[0]]: tensor });
                detectedCards = drawBoxes(results[session.outputNames[0]].data, canvas, video.videoWidth, video.videoHeight);
                
                if (detectedCards.length > 0) {
                    status.innerText = `–í–∏–∂—É –∫–∞—Ä—Ç: ${detectedCards.length}`;
                    status.style.color = "#e0c097";
                } else {
                    status.innerText = "–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—ã...";
                    status.style.color = "#888";
                }
            } catch (e) { console.error(e); }
            requestAnimationFrame(() => detectFrame(video));
        }

        function drawBoxes(data, canvas, vW, vH) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,vW,vH);
            
            const numAnchors = 8400; // –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è 640px YOLOv8n
            let boxes = [];

            for (let i=0; i<numAnchors; i++) {
                let maxConf = 0;
                let classIdx = 0;
                for(let c=4; c<data.length/numAnchors; c++) {
                    if(data[c*numAnchors+i] > maxConf) { maxConf = data[c*numAnchors+i]; classIdx = c-4; }
                }
                if (maxConf > 0.45) { // –ß—É—Ç—å —Å—Ç—Ä–æ–∂–µ –ø–æ—Ä–æ–≥
                    const x = data[0*numAnchors+i]; const y = data[1*numAnchors+i];
                    const w = data[2*numAnchors+i]; const h = data[3*numAnchors+i];
                    boxes.push({ x: x, y: y, w: w, h: h, score: maxConf, classId: classIdx });
                }
            }
            
            // –ü—Ä–æ—Å—Ç–∞—è NMS (—á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –Ω–∞–ª–æ–∂–µ–Ω–∏—è)
            boxes.sort((a,b) => b.score - a.score);
            const cleanBoxes = [];
            while(boxes.length > 0) {
                const best = boxes.shift();
                cleanBoxes.push(best);
                boxes = boxes.filter(b => {
                    const x1 = Math.max(best.x - best.w/2, b.x - b.w/2);
                    const y1 = Math.max(best.y - best.h/2, b.y - b.h/2);
                    const x2 = Math.min(best.x + best.w/2, b.x + b.w/2);
                    const y2 = Math.min(best.y + best.h/2, b.y + b.h/2);
                    if (x2 < x1 || y2 < y1) return true;
                    const inter = (x2-x1)*(y2-y1);
                    const union = best.w*best.h + b.w*b.h - inter;
                    return (inter/union) < 0.5;
                });
            }

            const sx = vW/MODEL_SIZE; const sy = vH/MODEL_SIZE;
            const finalCards = [];

            ctx.lineWidth = 2; ctx.strokeStyle = "rgba(224, 192, 151, 0.8)";
            ctx.font = "bold 16px Roboto"; ctx.fillStyle = "#e0c097";

            cleanBoxes.forEach(box => {
                const realX = (box.x - box.w/2)*sx;
                const realY = (box.y - box.h/2)*sy;
                
                ctx.strokeRect(realX, realY, box.w*sx, box.h*sy);
                let card = TAROT_DATA[box.classId];
                if(card) {
                    finalCards.push({ id: box.classId, x: realX, name: card.name, image: card.image });
                    ctx.fillText(card.name, realX, realY - 5);
                }
            });

            // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã ID
            const unique = []; const seen = new Set();
            for (const c of finalCards) {
                if (!seen.has(c.id)) { seen.add(c.id); unique.push(c); }
            }
            return unique;
        }

        function captureRead() {
            if (detectedCards.length === 0) { alert("–Ø –Ω–µ –≤–∏–∂—É –∫–∞—Ä—Ç!"); return; }
            
            // üî• –°–û–†–¢–ò–†–û–í–ö–ê –°–õ–ï–í–ê –ù–ê–ü–†–ê–í–û (–ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ç—Ä–∏–ø–ª–µ—Ç–æ–≤)
            detectedCards.sort((a, b) => a.x - b.x);

            const box = document.getElementById('result-box');
            const container = document.getElementById('cards-container');
            const header = document.getElementById('res-header');
            const expertName = currentExpert === 'margot' ? "–ú–ê–†–ì–û" : "–ú–ï–°–°–ò–†";
            
            header.innerText = `–û–¢–í–ï–¢ –û–¢: ${expertName}`;
            container.innerHTML = "";

            detectedCards.forEach(c => {
                const div = document.createElement('div');
                div.className = 'card-item';
                div.onclick = () => openZoom(c);
                div.innerHTML = `<img src="${c.image}" class="card-visual"><div class="card-name-mini">${c.name}</div>`;
                container.appendChild(div);
            });

            const aiText = document.getElementById('ai-response');
            const cardNames = detectedCards.map(c => c.name).join(' ‚ûú ');
            aiText.innerHTML = `<strong style="color: #e0c097">–†–∞—Å–∫–ª–∞–¥:</strong><br>${cardNames}<br><br><i>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –∑—É–º–∞.</i>`;
            box.style.display = 'flex';
        }

        function closeResult() { document.getElementById('result-box').style.display = 'none'; }

        function openZoom(card) {
            const modal = document.getElementById('zoom-modal');
            const title = document.getElementById('zoom-title');
            const placeholder = document.getElementById('zoom-media-placeholder');
            
            title.innerText = card.name;
            // –î–ª—è –†–∞–π–¥–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É, —Ç.–∫. –≤–∏–¥–µ–æ —É –Ω–∞—Å –Ω–µ—Ç
            placeholder.innerHTML = `<img src="${card.image}" style="max-width: 90vw; max-height: 70vh; border: 2px solid #e0c097;">`;
            modal.style.display = 'flex';
        }

        function closeZoom() { document.getElementById('zoom-modal').style.display = 'none'; }
    </script>
</body>
</html>
