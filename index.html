<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA TAROT AI: STABLE</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/ort.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; color: #fff; }
        #app { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; }

        /* Видео во весь экран */
        #video-container { position: absolute; inset: 0; z-index: 1; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #preview-canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; }

        /* Слой с картами после сканирования */
        #virtual-table { position: absolute; inset: 0; z-index: 10; display: none; background: rgba(0,0,0,0.85); overflow-y: auto; padding: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; perspective: 1000px; }

        /* Интерфейс */
        #ui { position: absolute; inset: 0; z-index: 20; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 20px; }
        #top-bar { background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; border: 1px solid #00ffea; pointer-events: auto; }
        #status-text { color: #00ffea; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; }

        #scan-btn { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #00ffea; background: rgba(0,255,234,0.1); pointer-events: auto; cursor: pointer; box-shadow: 0 0 20px #00ffea; transition: 0.3s; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
        #scan-btn:active { transform: scale(0.9); background: rgba(0,255,234,0.4); }
        #scan-btn::after { content: "SCAN"; color: #00ffea; font-weight: bold; font-size: 12px; }

        #reset-btn { display: none; padding: 12px 25px; background: #ffd700; color: #000; border: none; border-radius: 25px; font-weight: bold; pointer-events: auto; cursor: pointer; z-index: 30; position: absolute; bottom: 40px; }

        #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); border: 2px solid #00ffea; padding: 30px; border-radius: 15px; z-index: 100; text-align: center; display: block; }

        /* Стили карт */
        .digital-card { width: 120px; height: 210px; position: relative; transform-style: preserve-3d; transition: transform 0.8s; }
        .digital-card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 10px; border: 2px solid #ffd700; background-size: cover; background-position: center; }
        .card-back { background-image: url('./cards/rubashka.png'); background-color: #222; }
        .card-front { transform: rotateY(180deg); background-color: #111; }
    </style>
</head>
<body>

<div id="app">
    <div id="loader">
        <div style="color: #00ffea; margin-bottom: 10px;">AURA AI ENGINE</div>
        <div id="load-status">Загрузка модулей...</div>
    </div>

    <div id="video-container">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="preview-canvas"></canvas>
    </div>

    <div id="virtual-table"></div>

    <div id="ui">
        <div id="top-bar"><span id="status-text">Инициализация...</span></div>
        <div id="scan-btn" onclick="scan()"></div>
    </div>
    
    <button id="reset-btn" onclick="resetScanner()">НОВЫЙ РАСКЛАД</button>
</div>

<canvas id="internal-canvas" width="800" height="800" style="display:none"></canvas>

<script>
const CONFIG = {
    modelPath: 'https://raw.githubusercontent.com/marataitester-blip/rider-scanner/main/best.onnx',
    imgSize: 800,
    confThreshold: 0.35, // Чуть поднял, чтобы меньше "шумело"
    iouThreshold: 0.45,
    cardsDir: './cards/'
};

// Исправленный порядок классов под твою модель
const CARDS_EN = [
    "00-TheFool","01-TheMagician","02-TheHighPriestess","03-TheEmpress","04-TheEmperor","05-TheHierophant","06-TheLovers","07-TheChariot","08-Strength","09-TheHermit","10-WheelOfFortune","11-Justice","12-TheHangedMan","13-Death","14-Temperance","15-TheDevil","16-TheTower","17-TheStar","18-TheMoon","19-TheSun","20-Judgement","21-TheWorld",
    "CardBacks",
    "Cups01","Cups02","Cups03","Cups04","Cups05","Cups06","Cups07","Cups08","Cups09","Cups10","Cups11","Cups12","Cups13","Cups14",
    "Pentacles01","Pentacles02","Pentacles03","Pentacles04","Pentacles05","Pentacles06","Pentacles07","Pentacles08","Pentacles09","Pentacles10","Pentacles11","Pentacles12","Pentacles13","Pentacles14",
    "Swords01","Swords02","Swords03","Swords04","Swords05","Swords06","Swords07","Swords08","Swords09","Swords10","Swords11","Swords12","Swords13","Swords14",
    "Wands01","Wands02","Wands03","Wands04","Wands05","Wands06","Wands07","Wands08","Wands09","Wands10","Wands11","Wands12","Wands13","Wands14"
];

let session, video, canvas, ctx, internalCanvas, iCtx, isBusy = false;

async function init() {
    const loadStatus = document.getElementById('load-status');
    try {
        // 1. Настройка WASM
        ort.env.wasm.wasmPaths = "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/";
        
        loadStatus.innerText = "Загрузка AI модели (22MB)...";
        session = await ort.InferenceSession.create(CONFIG.modelPath, { 
            executionProviders: ['wasm'],
            graphOptimizationLevel: 'all'
        });

        // 2. Запуск камеры
        loadStatus.innerText = "Доступ к камере...";
        video = document.getElementById('video');
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        video.srcObject = stream;

        // 3. Подготовка холстов
        canvas = document.getElementById('preview-canvas');
        ctx = canvas.getContext('2d');
        internalCanvas = document.getElementById('internal-canvas');
        iCtx = internalCanvas.getContext('2d', { willReadFrequently: true });

        video.onloadedmetadata = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            document.getElementById('loader').style.display = 'none';
            requestAnimationFrame(loop);
        };
    } catch (e) {
        loadStatus.style.color = "#ff4444";
        loadStatus.innerText = "Ошибка: " + e.message;
        console.error(e);
    }
}

// Постоянный цикл предпросмотра
async function loop() {
    if (isBusy || !session) { requestAnimationFrame(loop); return; }
    
    const boxes = await runAI();
    drawUI(boxes);
    requestAnimationFrame(loop);
}

async function runAI() {
    if (!video.videoWidth) return [];

    // Подготовка изображения (Letterbox)
    const size = CONFIG.imgSize;
    iCtx.fillStyle = '#000';
    iCtx.fillRect(0, 0, size, size);
    
    const scale = Math.min(size / video.videoWidth, size / video.videoHeight);
    const nw = video.videoWidth * scale;
    const nh = video.videoHeight * scale;
    const dx = (size - nw) / 2;
    const dy = (size - nh) / 2;
    
    iCtx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, dx, dy, nw, nh);

    // Подготовка тензора
    const imgData = iCtx.getImageData(0, 0, size, size);
    const input = new Float32Array(3 * size * size);
    for (let i = 0; i < size * size; i++) {
        input[i] = imgData.data[i * 4] / 255;           // R
        input[i + size * size] = imgData.data[i * 4 + 1] / 255; // G
        input[i + 2 * size * size] = imgData.data[i * 4 + 2] / 255; // B
    }

    const tensor = new ort.Tensor('float32', input, [1, 3, size, size]);
    const results = await session.run({ [session.inputNames[0]]: tensor });
    const output = results[session.outputNames[0]];

    return parseOutput(output, scale, dx, dy);
}

function parseOutput(output, scale, padX, padY) {
    const data = output.data;
    const [batch, dims, anchors] = output.dims; // [1, 83, 13125]
    const boxes = [];

    for (let i = 0; i < anchors; i++) {
        let maxConf = 0;
        let classId = -1;

        // Ищем лучший класс среди 79
        for (let j = 0; j < 79; j++) {
            const conf = data[(j + 4) * anchors + i];
            if (conf > maxConf) {
                maxConf = conf;
                classId = j;
            }
        }

        if (maxConf > CONFIG.confThreshold) {
            const cx = data[0 * anchors + i];
            const cy = data[1 * anchors + i];
            const w = data[2 * anchors + i];
            const h = data[3 * anchors + i];

            // Пересчет координат обратно в видео
            boxes.push({
                x: (cx - padX) / scale,
                y: (cy - padY) / scale,
                w: w / scale,
                h: h / scale,
                classId,
                score: maxConf
            });
        }
    }
    return nms(boxes);
}

function nms(boxes) {
    boxes.sort((a, b) => b.score - a.score);
    const result = [];
    while (boxes.length > 0) {
        const current = boxes.shift();
        result.push(current);
        boxes = boxes.filter(box => {
            const iou = calculateIOU(current, box);
            return iou < CONFIG.iouThreshold;
        });
    }
    return result;
}

function calculateIOU(box1, box2) {
    const x1 = Math.max(box1.x - box1.w/2, box2.x - box2.w/2);
    const y1 = Math.max(box1.y - box1.h/2, box2.y - box2.h/2);
    const x2 = Math.min(box1.x + box1.w/2, box2.x + box2.w/2);
    const y2 = Math.min(box1.y + box1.h/2, box2.y + box2.h/2);
    const width = Math.max(0, x2 - x1);
    const height = Math.max(0, y2 - y1);
    const intersection = width * height;
    const union = box1.w * box1.h + box2.w * box2.h - intersection;
    return intersection / union;
}

function drawUI(boxes) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const status = document.getElementById('status-text');
    status.innerText = boxes.length ? `ОБНАРУЖЕНО КАРТ: ${boxes.length}` : "ПОИСК КАРТ...";

    // Масштаб для отрисовки на экране
    const sc = Math.max(canvas.width / video.videoWidth, canvas.height / video.videoHeight);
    const offX = (canvas.width - video.videoWidth * sc) / 2;
    const offY = (canvas.height - video.videoHeight * sc) / 2;

    boxes.forEach(box => {
        ctx.strokeStyle = '#00ffea';
        ctx.lineWidth = 3;
        ctx.strokeRect(
            box.x * sc + offX - (box.w * sc) / 2,
            box.y * sc + offY - (box.h * sc) / 2,
            box.w * sc,
            box.h * sc
        );
    });
}

async function scan() {
    isBusy = true;
    const boxes = await runAI();
    if (boxes.length === 0) {
        alert("Карты не найдены. Попробуйте изменить ракурс.");
        isBusy = false;
        return;
    }

    document.getElementById('video-container').style.display = 'none';
    document.getElementById('ui').style.display = 'none';
    const table = document.getElementById('virtual-table');
    table.style.display = 'flex';
    table.innerHTML = '';
    
    boxes.forEach((box, i) => {
        const card = document.createElement('div');
        card.className = 'digital-card';
        const imgPath = box.classId === 22 ? CONFIG.cardsDir + 'rubashka.png' : CONFIG.cardsDir + CARDS_EN[box.classId] + '.jpg';
        
        card.innerHTML = `
            <div class="card-face card-back"></div>
            <div class="card-face card-front" style="background-image: url('${imgPath}')"></div>
        `;
        table.appendChild(card);
        setTimeout(() => card.classList.add('flipped'), i * 200);
    });

    document.getElementById('reset-btn').style.display = 'block';
}

function resetScanner() {
    isBusy = false;
    document.getElementById('virtual-table').style.display = 'none';
    document.getElementById('video-container').style.display = 'block';
    document.getElementById('ui').style.display = 'flex';
    document.getElementById('reset-btn').style.display = 'none';
}

window.onload = init;
</script>
</body>
</html>
