<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIDER GOLD: RESTORED</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/ort.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Roboto', sans-serif; }
        #app { position: relative; width: 100vw; height: 100vh; }
        
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        .header { background: rgba(0,0,0,0.6); padding: 15px; text-align: center; color: #ffd700; font-size: 18px; font-weight: bold; border-bottom: 1px solid #ffd700; pointer-events: auto; }
        .footer { padding: 40px; display: flex; justify-content: center; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); pointer-events: auto; }
        
        #shutter-btn { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #ffd700; background: rgba(255, 215, 0, 0.3); cursor: pointer; position: relative; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); transition: 0.1s; }
        #shutter-btn:active { transform: scale(0.9); background: #ffd700; }
        
        #status-pill { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); border: 1px solid #ffd700; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 14px; }
        
        #result-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0b0b0b; z-index: 50; display: none; flex-direction: column; }
        #visual-layout { flex: 2; background: #111; position: relative; margin: 10px; border: 1px dashed #ffd700; border-radius: 10px; overflow: hidden; }
        
        .layout-card { position: absolute; border: 2px solid #ffd700; border-radius: 6px; box-shadow: 0 5px 20px rgba(0,0,0,0.9); }
        .layout-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        .layout-card-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); color: #ffd700; font-size: 10px; white-space: nowrap; background: rgba(0,0,0,0.9); padding: 2px 6px; border-radius: 4px; }
        
        #result-controls { flex: 1; border-top: 2px solid #ffd700; background: #1a1a1a; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        #retry-btn { width: 80%; padding: 15px; background: transparent; color: #ffd700; font-weight: bold; font-size: 16px; border: 2px solid #ffd700; border-radius: 10px; cursor: pointer; }
        
        #loader { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width:40px; height:40px; border:4px solid #333; border-top:4px solid #ffd700; border-radius:50%; animation: spin 1s infinite; }
        #start-btn { display:none; margin-top:20px; padding:10px 30px; background:transparent; border:1px solid #ffd700; color:#ffd700; cursor: pointer; }
    </style>
</head>
<body>
<div id="app">
    <div id="loader">
        <h1 style="color:#ffd700;">RIDER GOLD</h1>
        <div class="spinner"></div>
        <p id="load-text" style="color:#666;">Загрузка (800px)...</p>
        <button id="start-btn" onclick="init()">СТАРТ</button>
    </div>
    <video id="video" playsinline muted autoplay></video>
    <canvas id="canvas"></canvas>
    <div id="ui-layer">
        <div class="header">СКАНЕР RIDER</div>
        <div id="status-pill">Наведите на карты</div>
        <div class="footer"><div id="shutter-btn" onclick="capture()"></div></div>
    </div>
    <div id="result-screen">
        <div id="visual-layout"></div>
        <div id="result-controls">
            <div style="color:#ffd700; font-size:18px;">ГОТОВО</div>
            <button id="retry-btn" onclick="retry()">СКАНИРОВАТЬ СНОВА</button>
        </div>
    </div>
</div>
<script>
    // === 1. БАЗА КАРТ ===
    const BASE_URL = "https://raw.githubusercontent.com/marataitester-blip/rider-tarot-card/main/Cards-jpg/Cards-jpg/";
    const CARDS_DB = [];
    const MAJORS_FILES = ["00-TheFool.jpg", "01-TheMagician.jpg", "02-TheHighPriestess.jpg", "03-TheEmpress.jpg", "04-TheEmperor.jpg", "05-TheHierophant.jpg", "06-TheLovers.jpg", "07-TheChariot.jpg", "08-Strength.jpg", "09-TheHermit.jpg", "10-WheelOfFortune.jpg", "11-Justice.jpg", "12-TheHangedMan.jpg", "13-Death.jpg", "14-Temperance.jpg", "15-TheDevil.jpg", "16-TheTower.jpg", "17-TheStar.jpg", "18-TheMoon.jpg", "19-TheSun.jpg", "20-Judgement.jpg", "21-TheWorld.jpg"];
    const MAJORS_RU = ["Шут", "Маг", "Жрица", "Императрица", "Император", "Жрец", "Влюбленные", "Колесница", "Сила", "Отшельник", "Колесо", "Справедливость", "Повешенный", "Смерть", "Умеренность", "Дьявол", "Башня", "Звезда", "Луна", "Солнце", "Суд", "Мир"];
    MAJORS_FILES.forEach((f, i) => CARDS_DB.push({ name: MAJORS_RU[i], img: BASE_URL + f }));
    const SUITS = [{id: "Wands", ru: "Жезлов"}, {id: "Cups", ru: "Кубков"}, {id: "Swords", ru: "Мечей"}, {id: "Pentacles", ru: "Пентаклей"}];
    const RANKS_RU = ["Туз", "2", "3", "4", "5", "6", "7", "8", "9", "10", "Паж", "Рыцарь", "Королева", "Король"];
    SUITS.forEach(suit => { for (let i = 1; i <= 14; i++) { CARDS_DB.push({ name: `${RANKS_RU[i-1]} ${suit.ru}`, img: BASE_URL + `${suit.id}${i.toString().padStart(2, '0')}.jpg` }); }});

    // === 2. КОНФИГУРАЦИЯ (ОРИГИНАЛЬНАЯ) ===
    ort.env.wasm.wasmPaths = "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/";
    const CONFIG = { 
        modelPath: './rider_gold_800.onnx', 
        modelSize: 800, 
        conf: 0.35, 
        nms: 0.45 
    };
    
    let session, isPaused = false, lastBoxes = [];
    const video = document.getElementById('video'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d'), pill = document.getElementById('status-pill');

    // === 3. ИНИЦИАЛИЗАЦИЯ ===
    async function init() {
        document.getElementById('start-btn').style.display = 'none';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 1920 } }, 
                audio: false 
            });
            video.srcObject = stream; video.play();
            await new Promise(r => video.onloadedmetadata = r);
            
            session = await ort.InferenceSession.create(CONFIG.modelPath, { executionProviders: ['wasm'] });
            document.getElementById('loader').style.display = 'none';
            
            resizeCanvas(); loop();
        } catch (e) { 
            alert(e.message); 
            document.getElementById('start-btn').style.display = 'block'; 
        }
    }
    
    window.onload = () => document.getElementById('start-btn').style.display = 'inline-block';
    function resizeCanvas() { canvas.width = video.videoWidth; canvas.height = video.videoHeight; }

    // === 4. ЦИКЛ (БЕЗ ТАЙЛИНГА, КЛАССИКА) ===
    async function loop() {
        if (isPaused) return;
        
        const mat = document.createElement('canvas'); 
        mat.width = CONFIG.modelSize; mat.height = CONFIG.modelSize;
        mat.getContext('2d').drawImage(video, 0, 0, CONFIG.modelSize, CONFIG.modelSize);
        
        const data = mat.getContext('2d').getImageData(0,0,CONFIG.modelSize,CONFIG.modelSize).data;
        const input = new Float32Array(3 * CONFIG.modelSize * CONFIG.modelSize);
        
        for (let i=0; i<CONFIG.modelSize**2; i++) { 
            input[i] = data[i*4]/255.0; 
            input[CONFIG.modelSize**2+i] = data[i*4+1]/255.0; 
            input[2*CONFIG.modelSize**2+i] = data[i*4+2]/255.0; 
        }
        
        const tensor = new ort.Tensor('float32', input, [1, 3, CONFIG.modelSize, CONFIG.modelSize]);
        
        try { 
            const res = await session.run({ [session.inputNames[0]]: tensor }); 
            drawBoxes(res[session.outputNames[0]].data, res[session.outputNames[0]].dims); 
        } catch(e) {}
        
        requestAnimationFrame(loop);
    }

    // === 5. ОБРАБОТКА И РИСОВАНИЕ ===
    function drawBoxes(data, dims) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        let boxes = [];
        
        // УНИВЕРСАЛЬНЫЙ ПАРСЕР (Для v8 и v10)
        // Если это v10 [1, 300, 6]
        if (dims && dims[2] === 6) {
            const count = dims[1];
            for(let i=0; i<count; i++) {
                const off = i*6;
                const score = data[off+4];
                if(score > CONFIG.conf) {
                    boxes.push({
                        x: data[off], y: data[off+1], w: data[off+2]-data[off], h: data[off+3]-data[off+1], // v10 gives x1,y1,x2,y2
                        score: score, cls: data[off+5]
                    });
                    // Корректировка для v10: конвертируем в cx, cy, w, h для совместимости
                    let b = boxes[boxes.length-1];
                    b.w = b.w; b.h = b.h; b.x = b.x + b.w/2; b.y = b.y + b.h/2;
                }
            }
        } 
        // Если это v8 (Классика Rider Gold 800)
        else {
            const numClasses = 78; 
            const anchors = 8400; // Стандарт v8
            
            // Если dims переданы, используем их для точности
            const actualAnchors = dims ? dims[2] : 8400;
            
            for(let i=0; i<actualAnchors; i++) {
                let max = 0, cls = 0;
                for(let c=0; c<numClasses; c++) { 
                    let val = data[(c+4)*actualAnchors+i]; 
                    if(val > max) { max = val; cls = c; } 
                }
                if(max > CONFIG.conf) {
                    boxes.push({
                        x: data[0*actualAnchors+i], 
                        y: data[1*actualAnchors+i], 
                        w: data[2*actualAnchors+i], 
                        h: data[3*actualAnchors+i], 
                        score: max, cls: cls
                    });
                }
            }
        }
        
        // NMS
        boxes.sort((a,b) => b.score - a.score);
        let active = [];
        while(boxes.length) {
            let best = boxes.shift(); active.push(best);
            boxes = boxes.filter(b => {
                let x1 = Math.max(best.x-best.w/2, b.x-b.w/2), y1 = Math.max(best.y-best.h/2, b.y-b.h/2);
                let x2 = Math.min(best.x+best.w/2, b.x+b.w/2), y2 = Math.min(best.y+best.h/2, b.y+b.h/2);
                if(x2<x1 || y2<y1) return true;
                return ((x2-x1)*(y2-y1)) / (best.w*best.h + b.w*b.h - (x2-x1)*(y2-y1)) < CONFIG.nms;
            });
        }
        
        lastBoxes = active; 
        pill.innerText = `Карт: ${active.length}`;
        
        const sx = canvas.width / CONFIG.modelSize; 
        const sy = canvas.height / CONFIG.modelSize;
        
        ctx.lineWidth = 3; ctx.strokeStyle = "#ffd700";
        active.forEach(b => {
            ctx.strokeRect((b.x - b.w/2)*sx, (b.y - b.h/2)*sy, b.w*sx, b.h*sy);
        });
    }

    // === 6. ФИНАЛЬНЫЙ РЕНДЕР (ТВОЯ ГЕОМЕТРИЯ) ===
    function capture() {
        if(lastBoxes.length === 0) { alert("Нет карт!"); return; }
        isPaused = true; video.pause();
        document.getElementById('ui-layer').style.display = 'none';
        document.getElementById('result-screen').style.display = 'flex';
        renderVisual(lastBoxes);
    }

    function renderVisual(boxes) {
        const container = document.getElementById('visual-layout'); container.innerHTML = "";
        
        let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
        boxes.forEach(b => { minX=Math.min(minX, b.x); maxX=Math.max(maxX, b.x); minY=Math.min(minY, b.y); maxY=Math.max(maxY, b.y); });
        
        let W = (maxX - minX) * 1.5 || 100, H = (maxY - minY) * 1.5 || 100;
        let cX = (minX + maxX) / 2, cY = (minY + maxY) / 2;
        
        boxes.forEach(b => {
            let card = CARDS_DB[b.cls]; if(!card) return;
            let el = document.createElement('div'); el.className = 'layout-card';
            
            let left = 50 + ((b.x - cX) / W) * 80; 
            let top = 50 + ((b.y - cY) / H) * 80; 
            let width = (b.w / W) * 70;
            
            el.style.left = left + "%"; 
            el.style.top = top + "%"; 
            el.style.width = width + "%"; 
            el.style.height = (width * 1.7) + "%"; 
            el.style.transform = "translate(-50%, -50%)";
            
            el.innerHTML = `<img src="${card.img}"><div class="layout-card-label">${card.name}</div>`;
            container.appendChild(el);
        });
    }
    
    function retry() { isPaused = false; video.play(); document.getElementById('result-screen').style.display = 'none'; document.getElementById('ui-layer').style.display = 'flex'; loop(); }
</script>
</body>
</html><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIDER GOLD: RESTORED</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/ort.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Roboto', sans-serif; }
        #app { position: relative; width: 100vw; height: 100vh; }
        
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        .header { background: rgba(0,0,0,0.6); padding: 15px; text-align: center; color: #ffd700; font-size: 18px; font-weight: bold; border-bottom: 1px solid #ffd700; pointer-events: auto; }
        .footer { padding: 40px; display: flex; justify-content: center; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); pointer-events: auto; }
        
        #shutter-btn { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #ffd700; background: rgba(255, 215, 0, 0.3); cursor: pointer; position: relative; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); transition: 0.1s; }
        #shutter-btn:active { transform: scale(0.9); background: #ffd700; }
        
        #status-pill { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); border: 1px solid #ffd700; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 14px; }
        
        #result-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0b0b0b; z-index: 50; display: none; flex-direction: column; }
        #visual-layout { flex: 2; background: #111; position: relative; margin: 10px; border: 1px dashed #ffd700; border-radius: 10px; overflow: hidden; }
        
        .layout-card { position: absolute; border: 2px solid #ffd700; border-radius: 6px; box-shadow: 0 5px 20px rgba(0,0,0,0.9); }
        .layout-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        .layout-card-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); color: #ffd700; font-size: 10px; white-space: nowrap; background: rgba(0,0,0,0.9); padding: 2px 6px; border-radius: 4px; }
        
        #result-controls { flex: 1; border-top: 2px solid #ffd700; background: #1a1a1a; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        #retry-btn { width: 80%; padding: 15px; background: transparent; color: #ffd700; font-weight: bold; font-size: 16px; border: 2px solid #ffd700; border-radius: 10px; cursor: pointer; }
        
        #loader { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width:40px; height:40px; border:4px solid #333; border-top:4px solid #ffd700; border-radius:50%; animation: spin 1s infinite; }
        #start-btn { display:none; margin-top:20px; padding:10px 30px; background:transparent; border:1px solid #ffd700; color:#ffd700; cursor: pointer; }
    </style>
</head>
<body>
<div id="app">
    <div id="loader">
        <h1 style="color:#ffd700;">RIDER GOLD</h1>
        <div class="spinner"></div>
        <p id="load-text" style="color:#666;">Загрузка (800px)...</p>
        <button id="start-btn" onclick="init()">СТАРТ</button>
    </div>
    <video id="video" playsinline muted autoplay></video>
    <canvas id="canvas"></canvas>
    <div id="ui-layer">
        <div class="header">СКАНЕР RIDER</div>
        <div id="status-pill">Наведите на карты</div>
        <div class="footer"><div id="shutter-btn" onclick="capture()"></div></div>
    </div>
    <div id="result-screen">
        <div id="visual-layout"></div>
        <div id="result-controls">
            <div style="color:#ffd700; font-size:18px;">ГОТОВО</div>
            <button id="retry-btn" onclick="retry()">СКАНИРОВАТЬ СНОВА</button>
        </div>
    </div>
</div>
<script>
    // === 1. БАЗА КАРТ ===
    const BASE_URL = "https://raw.githubusercontent.com/marataitester-blip/rider-tarot-card/main/Cards-jpg/Cards-jpg/";
    const CARDS_DB = [];
    const MAJORS_FILES = ["00-TheFool.jpg", "01-TheMagician.jpg", "02-TheHighPriestess.jpg", "03-TheEmpress.jpg", "04-TheEmperor.jpg", "05-TheHierophant.jpg", "06-TheLovers.jpg", "07-TheChariot.jpg", "08-Strength.jpg", "09-TheHermit.jpg", "10-WheelOfFortune.jpg", "11-Justice.jpg", "12-TheHangedMan.jpg", "13-Death.jpg", "14-Temperance.jpg", "15-TheDevil.jpg", "16-TheTower.jpg", "17-TheStar.jpg", "18-TheMoon.jpg", "19-TheSun.jpg", "20-Judgement.jpg", "21-TheWorld.jpg"];
    const MAJORS_RU = ["Шут", "Маг", "Жрица", "Императрица", "Император", "Жрец", "Влюбленные", "Колесница", "Сила", "Отшельник", "Колесо", "Справедливость", "Повешенный", "Смерть", "Умеренность", "Дьявол", "Башня", "Звезда", "Луна", "Солнце", "Суд", "Мир"];
    MAJORS_FILES.forEach((f, i) => CARDS_DB.push({ name: MAJORS_RU[i], img: BASE_URL + f }));
    const SUITS = [{id: "Wands", ru: "Жезлов"}, {id: "Cups", ru: "Кубков"}, {id: "Swords", ru: "Мечей"}, {id: "Pentacles", ru: "Пентаклей"}];
    const RANKS_RU = ["Туз", "2", "3", "4", "5", "6", "7", "8", "9", "10", "Паж", "Рыцарь", "Королева", "Король"];
    SUITS.forEach(suit => { for (let i = 1; i <= 14; i++) { CARDS_DB.push({ name: `${RANKS_RU[i-1]} ${suit.ru}`, img: BASE_URL + `${suit.id}${i.toString().padStart(2, '0')}.jpg` }); }});

    // === 2. КОНФИГУРАЦИЯ (ОРИГИНАЛЬНАЯ) ===
    ort.env.wasm.wasmPaths = "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/";
    const CONFIG = { 
        modelPath: './rider_gold_800.onnx', 
        modelSize: 800, 
        conf: 0.35, 
        nms: 0.45 
    };
    
    let session, isPaused = false, lastBoxes = [];
    const video = document.getElementById('video'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d'), pill = document.getElementById('status-pill');

    // === 3. ИНИЦИАЛИЗАЦИЯ ===
    async function init() {
        document.getElementById('start-btn').style.display = 'none';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 1920 } }, 
                audio: false 
            });
            video.srcObject = stream; video.play();
            await new Promise(r => video.onloadedmetadata = r);
            
            session = await ort.InferenceSession.create(CONFIG.modelPath, { executionProviders: ['wasm'] });
            document.getElementById('loader').style.display = 'none';
            
            resizeCanvas(); loop();
        } catch (e) { 
            alert(e.message); 
            document.getElementById('start-btn').style.display = 'block'; 
        }
    }
    
    window.onload = () => document.getElementById('start-btn').style.display = 'inline-block';
    function resizeCanvas() { canvas.width = video.videoWidth; canvas.height = video.videoHeight; }

    // === 4. ЦИКЛ (БЕЗ ТАЙЛИНГА, КЛАССИКА) ===
    async function loop() {
        if (isPaused) return;
        
        const mat = document.createElement('canvas'); 
        mat.width = CONFIG.modelSize; mat.height = CONFIG.modelSize;
        mat.getContext('2d').drawImage(video, 0, 0, CONFIG.modelSize, CONFIG.modelSize);
        
        const data = mat.getContext('2d').getImageData(0,0,CONFIG.modelSize,CONFIG.modelSize).data;
        const input = new Float32Array(3 * CONFIG.modelSize * CONFIG.modelSize);
        
        for (let i=0; i<CONFIG.modelSize**2; i++) { 
            input[i] = data[i*4]/255.0; 
            input[CONFIG.modelSize**2+i] = data[i*4+1]/255.0; 
            input[2*CONFIG.modelSize**2+i] = data[i*4+2]/255.0; 
        }
        
        const tensor = new ort.Tensor('float32', input, [1, 3, CONFIG.modelSize, CONFIG.modelSize]);
        
        try { 
            const res = await session.run({ [session.inputNames[0]]: tensor }); 
            drawBoxes(res[session.outputNames[0]].data, res[session.outputNames[0]].dims); 
        } catch(e) {}
        
        requestAnimationFrame(loop);
    }

    // === 5. ОБРАБОТКА И РИСОВАНИЕ ===
    function drawBoxes(data, dims) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        let boxes = [];
        
        // УНИВЕРСАЛЬНЫЙ ПАРСЕР (Для v8 и v10)
        // Если это v10 [1, 300, 6]
        if (dims && dims[2] === 6) {
            const count = dims[1];
            for(let i=0; i<count; i++) {
                const off = i*6;
                const score = data[off+4];
                if(score > CONFIG.conf) {
                    boxes.push({
                        x: data[off], y: data[off+1], w: data[off+2]-data[off], h: data[off+3]-data[off+1], // v10 gives x1,y1,x2,y2
                        score: score, cls: data[off+5]
                    });
                    // Корректировка для v10: конвертируем в cx, cy, w, h для совместимости
                    let b = boxes[boxes.length-1];
                    b.w = b.w; b.h = b.h; b.x = b.x + b.w/2; b.y = b.y + b.h/2;
                }
            }
        } 
        // Если это v8 (Классика Rider Gold 800)
        else {
            const numClasses = 78; 
            const anchors = 8400; // Стандарт v8
            
            // Если dims переданы, используем их для точности
            const actualAnchors = dims ? dims[2] : 8400;
            
            for(let i=0; i<actualAnchors; i++) {
                let max = 0, cls = 0;
                for(let c=0; c<numClasses; c++) { 
                    let val = data[(c+4)*actualAnchors+i]; 
                    if(val > max) { max = val; cls = c; } 
                }
                if(max > CONFIG.conf) {
                    boxes.push({
                        x: data[0*actualAnchors+i], 
                        y: data[1*actualAnchors+i], 
                        w: data[2*actualAnchors+i], 
                        h: data[3*actualAnchors+i], 
                        score: max, cls: cls
                    });
                }
            }
        }
        
        // NMS
        boxes.sort((a,b) => b.score - a.score);
        let active = [];
        while(boxes.length) {
            let best = boxes.shift(); active.push(best);
            boxes = boxes.filter(b => {
                let x1 = Math.max(best.x-best.w/2, b.x-b.w/2), y1 = Math.max(best.y-best.h/2, b.y-b.h/2);
                let x2 = Math.min(best.x+best.w/2, b.x+b.w/2), y2 = Math.min(best.y+best.h/2, b.y+b.h/2);
                if(x2<x1 || y2<y1) return true;
                return ((x2-x1)*(y2-y1)) / (best.w*best.h + b.w*b.h - (x2-x1)*(y2-y1)) < CONFIG.nms;
            });
        }
        
        lastBoxes = active; 
        pill.innerText = `Карт: ${active.length}`;
        
        const sx = canvas.width / CONFIG.modelSize; 
        const sy = canvas.height / CONFIG.modelSize;
        
        ctx.lineWidth = 3; ctx.strokeStyle = "#ffd700";
        active.forEach(b => {
            ctx.strokeRect((b.x - b.w/2)*sx, (b.y - b.h/2)*sy, b.w*sx, b.h*sy);
        });
    }

    // === 6. ФИНАЛЬНЫЙ РЕНДЕР (ТВОЯ ГЕОМЕТРИЯ) ===
    function capture() {
        if(lastBoxes.length === 0) { alert("Нет карт!"); return; }
        isPaused = true; video.pause();
        document.getElementById('ui-layer').style.display = 'none';
        document.getElementById('result-screen').style.display = 'flex';
        renderVisual(lastBoxes);
    }

    function renderVisual(boxes) {
        const container = document.getElementById('visual-layout'); container.innerHTML = "";
        
        let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
        boxes.forEach(b => { minX=Math.min(minX, b.x); maxX=Math.max(maxX, b.x); minY=Math.min(minY, b.y); maxY=Math.max(maxY, b.y); });
        
        let W = (maxX - minX) * 1.5 || 100, H = (maxY - minY) * 1.5 || 100;
        let cX = (minX + maxX) / 2, cY = (minY + maxY) / 2;
        
        boxes.forEach(b => {
            let card = CARDS_DB[b.cls]; if(!card) return;
            let el = document.createElement('div'); el.className = 'layout-card';
            
            let left = 50 + ((b.x - cX) / W) * 80; 
            let top = 50 + ((b.y - cY) / H) * 80; 
            let width = (b.w / W) * 70;
            
            el.style.left = left + "%"; 
            el.style.top = top + "%"; 
            el.style.width = width + "%"; 
            el.style.height = (width * 1.7) + "%"; 
            el.style.transform = "translate(-50%, -50%)";
            
            el.innerHTML = `<img src="${card.img}"><div class="layout-card-label">${card.name}</div>`;
            container.appendChild(el);
        });
    }
    
    function retry() { isPaused = false; video.play(); document.getElementById('result-screen').style.display = 'none'; document.getElementById('ui-layer').style.display = 'flex'; loop(); }
</script>
</body>
</html>
