<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAROT SCANNER: RIDER WAITE</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #0f0f0f; overflow: hidden; font-family: 'Roboto', sans-serif; color: #e0c097; }
        #container { position: relative; width: 100vw; height: 100vh; }
        
        video#input-video { width: 100%; height: 100%; object-fit: cover; display: none; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* UI –ò–ù–¢–ï–†–§–ï–ô–° */
        .ui-layer { position: absolute; top:0; left:0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 20; }
        
        .top-panel { background: rgba(0,0,0,0.85); padding: 15px; pointer-events: auto; border-bottom: 2px solid #e0c097; text-align: center; }
        .app-title { font-family: 'Cinzel', serif; font-size: 22px; color: #e0c097; letter-spacing: 3px; text-shadow: 0 0 10px rgba(224, 192, 151, 0.5); }
        
        .bottom-panel { padding: 30px; pointer-events: auto; text-align: center; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); }
        .scan-btn { background: #e0c097; color: #000; border: 4px solid #bba078; width: 85px; height: 85px; border-radius: 50%; font-size: 40px; box-shadow: 0 0 30px rgba(224, 192, 151, 0.4); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .scan-btn:active { transform: scale(0.95); }

        /* === –û–ü–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–¶–ï–õ (HUD) === */
        .hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0.7; }
        
        .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; }
        .crosshair::before, .crosshair::after { content: ''; position: absolute; background: rgba(224, 192, 151, 0.6); }
        .crosshair::before { top: 19px; left: 0; width: 40px; height: 2px; } 
        .crosshair::after { top: 0; left: 19px; width: 2px; height: 40px; } 

        .scan-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 60%; border: 2px solid rgba(224, 192, 151, 0.3); border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5) inset; animation: breathe 3s infinite ease-in-out; }
        .corner { position: absolute; width: 30px; height: 30px; border-color: #e0c097; border-style: solid; border-width: 0; }
        .tl { top: -2px; left: -2px; border-top-width: 4px; border-left-width: 4px; border-radius: 10px 0 0 0; }
        .tr { top: -2px; right: -2px; border-top-width: 4px; border-right-width: 4px; border-radius: 0 10px 0 0; }
        .bl { bottom: -2px; left: -2px; border-bottom-width: 4px; border-left-width: 4px; border-radius: 0 0 0 10px; }
        .br { bottom: -2px; right: -2px; border-bottom-width: 4px; border-right-width: 4px; border-radius: 0 0 10px 0; }
        @keyframes breathe { 0% { opacity: 0.5; border-color: rgba(224, 192, 151, 0.2); } 50% { opacity: 1; border-color: rgba(224, 192, 151, 0.6); } 100% { opacity: 0.5; border-color: rgba(224, 192, 151, 0.2); } }

        /* –†–ï–ó–£–õ–¨–¢–ê–¢ */
        #result-box { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 100; display: none; pointer-events: auto; flex-direction: column; }
        .result-scroll-area { flex: 1; overflow-y: auto; padding: 20px; text-align: center; }
        .cards-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 30px; margin-top: 20px;}
        .card-item { width: 30%; min-width: 90px; max-width: 140px; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .card-visual { width: 100%; border-radius: 6px; border: 1px solid #e0c097; }
        .card-name-mini { font-size: 12px; margin-top: 8px; color: #fff; text-align: center; font-family: 'Cinzel', serif; }
        .close-res { margin: 20px; padding: 15px 40px; background: transparent; color: #e0c097; border: 1px solid #e0c097; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; font-family: 'Cinzel', serif; transition: 0.3s; }
        .close-res:hover { background: #e0c097; color: #000; }

        /* –ó–£–ú */
        #zoom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 200; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #zoom-title { color: #e0c097; font-family: 'Cinzel', serif; font-size: 24px; margin-bottom: 20px; }

        /* üî• –°–¢–ò–õ–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø */
        .edit-btn { margin-top: 20px; padding: 10px 20px; background: #333; color: #e0c097; border: 1px solid #e0c097; cursor: pointer; font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 1px; transition: 0.3s; border-radius: 5px; }
        .edit-btn:hover { background: #e0c097; color: #000; }

        #card-selector { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0f0f; z-index: 300; display: none; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .selector-header { font-family: 'Cinzel'; color: #e0c097; font-size: 20px; text-align: center; margin-bottom: 20px; border-bottom: 1px solid #e0c097; padding-bottom: 10px; }
        .selector-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; overflow-y: auto; flex: 1; }
        .selector-item { background: #1a1a1a; padding: 10px; border: 1px solid #444; color: #ccc; cursor: pointer; width: 45%; text-align: center; font-size: 12px; border-radius: 4px; font-family: 'Roboto'; }
        .selector-item:hover { background: #e0c097; color: #000; border-color: #fff; }
        .close-selector { margin-top: 10px; padding: 15px; background: transparent; border: 1px solid #e0c097; color: #e0c097; width: 100%; font-family: 'Cinzel'; font-weight: bold; cursor: pointer; }

        /* –ó–ê–ì–†–£–ó–ö–ê */
        #start-screen { position: absolute; top:0; left:0; width:100%; height:100%; background:#0f0f0f; z-index:999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease; }
        .logo-text { font-family: 'Cinzel', serif; font-size: 32px; color: #e0c097; margin-bottom: 40px; text-align: center; letter-spacing: 4px; border-bottom: 1px solid #e0c097; padding-bottom: 10px; text-shadow: 0 0 15px #e0c097; }
        #big-start-btn { padding: 15px 40px; font-size: 16px; background: transparent; color: #e0c097; border: 1px solid #e0c097; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; transition: all 0.3s; }
        
        .status-text { position: absolute; bottom: 130px; width: 100%; text-align: center; font-size: 20px; font-weight: bold; letter-spacing: 1px; text-shadow: 0 0 5px #000; color: #fff; background: rgba(0,0,0,0.4); padding: 8px; font-family: 'Cinzel', serif; }
        #error-log { color: #ff5555; margin-top: 15px; font-size: 12px; max-width: 80%; text-align: center; }
    </style>
</head>
<body>

    <div id="container">
        <div id="start-screen">
            <div class="logo-text">RIDER WAITE<br>TRIPLET</div>
            <button id="big-start-btn" onclick="initSystem()">START SESSION</button>
            <div id="loading-text" style="color: #666; margin-top: 15px; font-size: 12px; display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (Hardcore)...</div>
            <div id="error-log"></div>
        </div>

        <video id="input-video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
        
        <div class="hud-layer">
            <div class="scan-frame">
                <div class="corner tl"></div><div class="corner tr"></div>
                <div class="corner bl"></div><div class="corner br"></div>
            </div>
            <div class="crosshair"></div>
        </div>
        
        <div class="ui-layer">
            <div class="top-panel"><div class="app-title">RIDER HARDCORE</div></div>
            <div id="status" class="status-text">–û–ñ–ò–î–ê–ù–ò–ï...</div>
            <div class="bottom-panel"><button class="scan-btn" onclick="captureRead()">üì∑</button></div>
        </div>

        <div id="result-box">
            <div class="result-scroll-area">
                <h2 style="color: #e0c097; font-family: 'Cinzel'; margin-bottom: 10px;">–†–ê–°–ö–õ–ê–î</h2>
                <div id="cards-container" class="cards-row"></div>
                <div style="color: #888; font-size: 12px; margin-top: 20px;">
                    * –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä—è–º—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏.<br>–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—ã–µ –∫–∞—Ä—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∫–∞–∫ –ø—Ä—è–º—ã–µ.
                </div>
            </div>
            <button class="close-res" onclick="closeResult()">–ù–û–í–´–ô –°–ö–ê–ù</button>
        </div>

        <div id="zoom-modal">
            <div id="zoom-title">–ö–∞—Ä—Ç–∞</div>
            <div id="zoom-media-placeholder"></div>
            <button class="edit-btn" onclick="openCardSelector()">‚ö†Ô∏è –û–®–ò–ë–ö–ê? –ó–ê–ú–ï–ù–ò–¢–¨</button>
            <p style="color: #777; margin-top: 20px; font-size: 12px; cursor: pointer;" onclick="closeZoom()">(–ó–∞–∫—Ä—ã—Ç—å)</p>
        </div>

        <div id="card-selector">
            <div class="selector-header">–í–´–ë–ï–†–ò–¢–ï –ü–†–ê–í–ò–õ–¨–ù–£–Æ –ö–ê–†–¢–£</div>
            <div id="selector-grid" class="selector-grid"></div>
            <button class="close-selector" onclick="closeCardSelector()">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <script>
        // === 1. –ë–ê–ó–ê –ö–ê–†–¢ ===
        const BASE_IMG_URL = "https://raw.githubusercontent.com/marataitester-blip/rider-tarot-card/main/Cards-jpg/Cards-jpg/";
        const TAROT_DATA = [];

        const majors = [
            {n:"–®—É—Ç", f:"00-TheFool.jpg"}, {n:"–ú–∞–≥", f:"01-TheMagician.jpg"}, {n:"–ñ—Ä–∏—Ü–∞", f:"02-TheHighPriestess.jpg"},
            {n:"–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", f:"03-TheEmpress.jpg"}, {n:"–ò–º–ø–µ—Ä–∞—Ç–æ—Ä", f:"04-TheEmperor.jpg"}, {n:"–ñ—Ä–µ—Ü", f:"05-TheHierophant.jpg"},
            {n:"–í–ª—é–±–ª–µ–Ω–Ω—ã–µ", f:"06-TheLovers.jpg"}, {n:"–ö–æ–ª–µ—Å–Ω–∏—Ü–∞", f:"07-TheChariot.jpg"}, {n:"–°–∏–ª–∞", f:"08-Strength.jpg"},
            {n:"–û—Ç—à–µ–ª—å–Ω–∏–∫", f:"09-TheHermit.jpg"}, {n:"–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", f:"10-WheelOfFortune.jpg"}, {n:"–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å", f:"11-Justice.jpg"},
            {n:"–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", f:"12-TheHangedMan.jpg"}, {n:"–°–º–µ—Ä—Ç—å", f:"13-Death.jpg"}, {n:"–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", f:"14-Temperance.jpg"},
            {n:"–î—å—è–≤–æ–ª", f:"15-TheDevil.jpg"}, {n:"–ë–∞—à–Ω—è", f:"16-TheTower.jpg"}, {n:"–ó–≤–µ–∑–¥–∞", f:"17-TheStar.jpg"},
            {n:"–õ—É–Ω–∞", f:"18-TheMoon.jpg"}, {n:"–°–æ–ª–Ω—Ü–µ", f:"19-TheSun.jpg"}, {n:"–°—É–¥", f:"20-Judgement.jpg"},
            {n:"–ú–∏—Ä", f:"21-TheWorld.jpg"}
        ];
        majors.forEach(m => TAROT_DATA.push({ name: m.n, image: BASE_IMG_URL + m.f }));

        const suits = [{id: 'Wands', ru: '–ñ–µ–∑–ª–æ–≤'}, {id: 'Cups', ru: '–ö—É–±–∫–æ–≤'}, {id: 'Swords', ru: '–ú–µ—á–µ–π'}, {id: 'Pentacles', ru: '–ü–µ–Ω—Ç–∞–∫–ª–µ–π'}];
        const ranks = ['–¢—É–∑', '2', '3', '4', '5', '6', '7', '8', '9', '10', '–ü–∞–∂', '–†—ã—Ü–∞—Ä—å', '–ö–æ—Ä–æ–ª–µ–≤–∞', '–ö–æ—Ä–æ–ª—å'];
        suits.forEach(s => {
            ranks.forEach((r, idx) => {
                const num = (idx + 1).toString().padStart(2, '0');
                TAROT_DATA.push({ name: `${r} ${s.ru}`, image: BASE_IMG_URL + `${s.id}${num}.jpg` });
            });
        });

        // === 2. –ù–ê–°–¢–†–û–ô–ö–ò (–†–ê–ë–û–ß–ò–ï) ===
        const MODEL_PATH = 'rider_hardcore.onnx'; 
        const MODEL_SIZE = 800; 
        const CONFIDENCE = 0.25; 
        const NMS_THRESHOLD = 0.50;

        let session;
        let detectedCards = []; 
        let currentZoomIndex = -1; // üî• –¢–ï–ö–£–©–ò–ô –ò–ù–î–ï–ö–° –ö–ê–†–¢–´ –î–õ–Ø –ó–ê–ú–ï–ù–´
        const status = document.getElementById('status');

        ort.env.wasm.numThreads = 2; ort.env.wasm.simd = false;

        async function initSystem() {
            const btn = document.getElementById('big-start-btn');
            const loadText = document.getElementById('loading-text');
            const errorLog = document.getElementById('error-log');
            
            btn.style.display = 'none';
            loadText.style.display = 'block';
            errorLog.innerText = "";

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} }, audio: false });
                const video = document.getElementById('input-video');
                video.srcObject = stream;
                video.style.display = 'block'; 
                await new Promise(r => video.onloadedmetadata = r);
                
                // –ü–†–û–°–¢–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ë–ï–ó –ü–†–û–í–ï–†–û–ö
                session = await ort.InferenceSession.create(MODEL_PATH, { executionProviders: ['wasm'] });

                document.getElementById('start-screen').style.opacity = '0';
                setTimeout(() => { document.getElementById('start-screen').style.display = 'none'; }, 800);

                status.innerText = "–ü–û–ò–°–ö –¶–ï–õ–ò...";
                status.style.color = "#888";
                detectFrame(video);

            } catch (e) {
                console.error(e);
                loadText.style.display = 'none';
                btn.style.display = 'inline-block';
                btn.innerText = "–ü–û–í–¢–û–†–ò–¢–¨";
                errorLog.innerText = "–û–®–ò–ë–ö–ê: " + e.message;
            }
        }

        async function detectFrame(video) {
            const canvas = document.getElementById('canvas');
            const mat = document.createElement('canvas');
            mat.width = MODEL_SIZE; mat.height = MODEL_SIZE;
            mat.getContext('2d').drawImage(video, 0, 0, MODEL_SIZE, MODEL_SIZE);
            const data = mat.getContext('2d').getImageData(0,0,MODEL_SIZE,MODEL_SIZE).data;
            const input = new Float32Array(3 * MODEL_SIZE * MODEL_SIZE);
            for (let i=0; i<MODEL_SIZE*MODEL_SIZE; i++) {
                input[i] = data[i*4]/255.0; input[MODEL_SIZE*MODEL_SIZE+i] = data[i*4+1]/255.0; input[2*MODEL_SIZE*MODEL_SIZE+i] = data[i*4+2]/255.0;
            }
            const tensor = new ort.Tensor('float32', input, [1, 3, MODEL_SIZE, MODEL_SIZE]);

            try {
                const results = await session.run({ [session.inputNames[0]]: tensor });
                const output = results[session.outputNames[0]].data;
                const rawCards = processAndDraw(output, canvas, video.videoWidth, video.videoHeight);
                
                // üî• –û–ë–ù–û–í–õ–Ø–ï–ú –¢–û–õ–¨–ö–û –ï–°–õ–ò –û–ö–ù–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê –ó–ê–ö–†–´–¢–û
                if (document.getElementById('result-box').style.display === 'none') {
                    detectedCards = rawCards;
                    if (detectedCards.length > 0) {
                        status.innerText = `–ó–ê–•–í–ê–ß–ï–ù–û –ö–ê–†–¢
