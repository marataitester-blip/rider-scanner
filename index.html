<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIDER GOLD 800</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* === 1. ОСНОВА === */
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Roboto', sans-serif; }
        #app { position: relative; width: 100vw; height: 100vh; }
        
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* === 2. ИНТЕРФЕЙС === */
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; 
            display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; 
        }
        
        .header { 
            background: rgba(0,0,0,0.6); padding: 15px; text-align: center; color: #ffd700; 
            font-size: 18px; font-weight: bold; letter-spacing: 2px; pointer-events: auto;
            border-bottom: 1px solid #ffd700; text-shadow: 0 2px 4px #000;
        }
        
        .footer { 
            padding: 40px; display: flex; justify-content: center; align-items: center; 
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); pointer-events: auto;
        }
        
        /* КНОПКА СЪЕМКИ */
        #shutter-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid #ffd700;
            background: rgba(255, 215, 0, 0.3); cursor: pointer; position: relative;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); transition: transform 0.1s;
        }
        #shutter-btn:active { transform: scale(0.9); background: #ffd700; }

        /* СТАТУС */
        #status-pill {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); border: 1px solid #ffd700; color: #fff;
            padding: 8px 16px; border-radius: 20px; font-size: 14px; text-transform: uppercase;
        }

        /* === 3. ЭКРАН РЕЗУЛЬТАТА === */
        #result-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0b0b0b; z-index: 50; display: none; flex-direction: column;
        }
        
        /* Стол с картами */
        #visual-layout {
            flex: 2; 
            background: #111; 
            position: relative; 
            margin: 10px; border: 1px dashed #ffd700; border-radius: 10px;
            overflow: hidden; 
        }
        
        .layout-card {
            position: absolute; border: 2px solid #ffd700; border-radius: 6px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.9); transition: all 0.3s;
        }
        .layout-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        
        .layout-card-label {
            position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
            color: #ffd700; font-size: 10px; white-space: nowrap; text-shadow: 0 1px 3px #000;
            background: rgba(0,0,0,0.9); padding: 2px 6px; border-radius: 4px; border: 1px solid #333;
        }

        /* Панель управления */
        #result-controls {
            flex: 1; border-top: 2px solid #ffd700; background: #1a1a1a;
            padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        
        .result-title { color: #ffd700; font-size: 20px; font-weight: bold; letter-spacing: 1px; }
        .result-subtitle { color: #888; font-size: 13px; text-align: center; }

        #retry-btn {
            width: 80%; padding: 15px; 
            background: transparent; color: #ffd700; font-weight: bold; font-size: 16px;
            border: 2px solid #ffd700; border-radius: 10px; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }
        #retry-btn:active { background: #ffd700; color: #000; }

        /* === 4. ЗАГРУЗЧИК === */
        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width:40px; height:40px; border:4px solid #333; border-top:4px solid #ffd700; border-radius:50%; animation: spin 1s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #start-btn { display:none; margin-top:20px; padding:10px 30px; background:transparent; border:1px solid #ffd700; color:#ffd700; cursor: pointer; }
        #err-log { color: red; font-size: 12px; margin-top: 20px; max-width: 80%; text-align: center; }
    </style>
</head>
<body>

<div id="app">
    <div id="loader">
        <h1 style="color: #ffd700; font-weight: normal; letter-spacing: 3px;">RIDER GOLD</h1>
        <div class="spinner"></div>
        <p id="load-text" style="color: #666; font-size: 12px; margin-top: 15px;">Загрузка нейросети (800px / 78 карт)...</p>
        <div id="err-log"></div>
        <button id="start-btn" onclick="init()">ЗАПУСТИТЬ</button>
    </div>

    <video id="video" playsinline muted autoplay></video>
    <canvas id="canvas"></canvas>

    <div id="ui-layer">
        <div class="header">СКАНЕР RIDER</div>
        <div id="status-pill">Наведите на карты</div>
        <div class="footer">
            <div id="shutter-btn" onclick="capture()"></div>
        </div>
    </div>

    <div id="result-screen">
        <div id="visual-layout">
            <div style="position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#444;">Нет карт</div>
        </div>

        <div id="result-controls">
            <div>
                <div class="result-title" style="text-align:center;">РАСКЛАД ПРИНЯТ</div>
                <div class="result-subtitle">Геометрия сохранена</div>
            </div>
            <button id="retry-btn" onclick="retry()">↺ СКАНИРОВАТЬ СНОВА</button>
        </div>
    </div>
</div>

<script>
    // === 1. БАЗА КАРТ RIDER WAITE (78 КАРТ) ===
    const BASE_URL = "https://raw.githubusercontent.com/marataitester-blip/rider-tarot-card/main/Cards-jpg/Cards-jpg/";
    const CARDS_DB = [];

    // Порядок строго как в тренировке (Majors -> Wands -> Cups -> Swords -> Pentacles)
    
    // 1. Старшие (00-21)
    const MAJORS_FILES = [
        "00-TheFool.jpg", "01-TheMagician.jpg", "02-TheHighPriestess.jpg", "03-TheEmpress.jpg",
        "04-TheEmperor.jpg", "05-TheHierophant.jpg", "06-TheLovers.jpg", "07-TheChariot.jpg",
        "08-Strength.jpg", "09-TheHermit.jpg", "10-WheelOfFortune.jpg", "11-Justice.jpg",
        "12-TheHangedMan.jpg", "13-Death.jpg", "14-Temperance.jpg", "15-TheDevil.jpg",
        "16-TheTower.jpg", "17-TheStar.jpg", "18-TheMoon.jpg", "19-TheSun.jpg",
        "20-Judgement.jpg", "21-TheWorld.jpg"
    ];
    const MAJORS_RU = [
        "Шут", "Маг", "Жрица", "Императрица", "Император", "Жрец", "Влюбленные", "Колесница",
        "Сила", "Отшельник", "Колесо Фортуны", "Справедливость", "Повешенный", "Смерть", "Умеренность",
        "Дьявол", "Башня", "Звезда", "Луна", "Солнце", "Суд", "Мир"
    ];

    MAJORS_FILES.forEach((f, i) => {
        CARDS_DB.push({ name: MAJORS_RU[i], img: BASE_URL + f });
    });

    // 2. Младшие (Wands, Cups, Swords, Pentacles)
    const SUITS = [
        {id: "Wands", ru: "Жезлов"}, {id: "Cups", ru: "Кубков"},
        {id: "Swords", ru: "Мечей"}, {id: "Pentacles", ru: "Пентаклей"}
    ];
    const RANKS_RU = ["Туз", "2", "3", "4", "5", "6", "7", "8", "9", "10", "Паж", "Рыцарь", "Королева", "Король"];
    
    SUITS.forEach(suit => {
        // В тренировке цикл был range(1, 15), файлы типа Wands01.jpg
        for (let i = 1; i <= 14; i++) {
            let numStr = i.toString().padStart(2, '0');
            let filename = `${suit.id}${numStr}.jpg`;
            let rankName = RANKS_RU[i-1];
            CARDS_DB.push({ name: `${rankName} ${suit.ru}`, img: BASE_URL + filename });
        }
    });

    // === 2. НАСТРОЙКИ (ПОД RIDER GOLD 800) ===
    const CONFIG = {
        modelPath: './rider_gold_800.onnx', // Твой файл
        modelSize: 800, // Разрешение тренировки
        conf: 0.35,     
        nms: 0.45       
    };

    let session = null;
    let isPaused = false;
    let lastBoxes = [];

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusPill = document.getElementById('status-pill');

    // === 3. ИНИЦИАЛИЗАЦИЯ ===
    async function init() {
        document.getElementById('start-btn').style.display = 'none';
        const loadTxt = document.getElementById('load-text');
        
        try {
            loadTxt.innerText = "Камера...";
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1920 } },
                audio: false
            });
            video.srcObject = stream;
            video.play();
            await new Promise(r => video.onloadedmetadata = r);

            loadTxt.innerText = "Загрузка rider_gold_800.onnx...";
            session = await ort.InferenceSession.create(CONFIG.modelPath, { executionProviders: ['wasm'] });

            document.getElementById('loader').style.display = 'none';
            resizeCanvas();
            loop();

        } catch (e) {
            console.error(e);
            document.getElementById('err-log').innerText = e.message + "\nУбедись, что файл rider_gold_800.onnx загружен.";
            document.getElementById('start-btn').style.display = 'block';
        }
    }
    window.onload = () => document.getElementById('start-btn').style.display = 'inline-block';

    function resizeCanvas() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
    }

    // === 4. ЦИКЛ РАСПОЗНАВАНИЯ ===
    async function loop() {
        if (isPaused) return;

        const mat = document.createElement('canvas');
        mat.width = CONFIG.modelSize; mat.height = CONFIG.modelSize;
        mat.getContext('2d').drawImage(video, 0, 0, CONFIG.modelSize, CONFIG.modelSize);
        const data = mat.getContext('2d').getImageData(0,0,CONFIG.modelSize,CONFIG.modelSize).data;
        
        const input = new Float32Array(3 * CONFIG.modelSize * CONFIG.modelSize);
        for (let i=0; i<CONFIG.modelSize*CONFIG.modelSize; i++) {
            input[i] = data[i*4]/255.0;
            input[CONFIG.modelSize*CONFIG.modelSize+i] = data[i*4+1]/255.0;
            input[2*CONFIG.modelSize*CONFIG.modelSize+i] = data[i*4+2]/255.0;
        }
        
        const tensor = new ort.Tensor('float32', input, [1, 3, CONFIG.modelSize, CONFIG.modelSize]);
        
        try {
            const res = await session.run({ [session.inputNames[0]]: tensor });
            drawBoxes(res[session.outputNames[0]].data);
        } catch(e) { console.error(e); }

        requestAnimationFrame(loop);
    }

    // === 5. ОТРИСОВКА ===
    function drawBoxes(data) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const numClasses = 78; 
        const channels = numClasses + 4;
        const anchors = data.length / channels;
        let boxes = [];

        for(let i=0; i<anchors; i++) {
            let max = 0, cls = 0;
            for(let c=4; c<channels; c++) {
                let val = data[c*anchors+i];
                if(val > max) { max = val; cls = c-4; }
            }
            if(max > CONFIG.conf) {
                const x = data[0*anchors+i]; const y = data[1*anchors+i];
                const w = data[2*anchors+i]; const h = data[3*anchors+i];
                boxes.push({x, y, w, h, score: max, cls});
            }
        }

        boxes.sort((a,b) => b.score - a.score);
        let active = [];
        while(boxes.length) {
            let best = boxes.shift(); active.push(best);
            boxes = boxes.filter(b => {
                let x1 = Math.max(best.x-best.w/2, b.x-b.w/2), y1 = Math.max(best.y-best.h/2, b.y-b.h/2);
                let x2 = Math.min(best.x+best.w/2, b.x+b.w/2), y2 = Math.min(best.y+best.h/2, b.y+b.h/2);
                if(x2<x1 || y2<y1) return true;
                let inter = (x2-x1)*(y2-y1);
                let union = (best.w*best.h) + (b.w*b.h) - inter;
                return (inter/union) < CONFIG.nms;
            });
        }

        lastBoxes = active;
        statusPill.innerText = `Найдено карт: ${active.length}`;

        const sx = canvas.width / CONFIG.modelSize;
        const sy = canvas.height / CONFIG.modelSize;
        
        ctx.lineWidth = 3;
        ctx.strokeStyle = "#00ff00"; // Зеленый прицел
        
        active.forEach(b => {
            ctx.strokeRect((b.x - b.w/2)*sx, (b.y - b.h/2)*sy, b.w*sx, b.h*sy);
        });
    }

    // === 6. СНИМОК И ГЕОМЕТРИЯ ===
    function capture() {
        if(lastBoxes.length === 0) { alert("Не вижу карт!"); return; }
        
        isPaused = true;
        video.pause();
        document.getElementById('ui-layer').style.display = 'none';
        document.getElementById('result-screen').style.display = 'flex';

        renderVisual(lastBoxes);
    }

    function renderVisual(boxes) {
        const container = document.getElementById('visual-layout');
        container.innerHTML = "";

        // Границы расклада
        let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
        boxes.forEach(b => {
            minX = Math.min(minX, b.x); maxX = Math.max(maxX, b.x);
            minY = Math.min(minY, b.y); maxY = Math.max(maxY, b.y);
        });
        
        // Размеры стола с отступами
        let W = (maxX - minX) * 1.5 || 100;
        let H = (maxY - minY) * 1.5 || 100;
        let cX = (minX + maxX) / 2;
        let cY = (minY + maxY) / 2;

        boxes.forEach(b => {
            let card = CARDS_DB[b.cls];
            if(!card) return;

            let el = document.createElement('div');
            el.className = 'layout-card';
            
            // Позиция в %
            let left = 50 + ((b.x - cX) / W) * 80;
            let top = 50 + ((b.y - cY) / H) * 80;
            let width = (b.w / W) * 70;
            
            el.style.left = left + "%";
            el.style.top = top + "%";
            el.style.width = width + "%";
            el.style.height = (width * 1.7) + "%"; // Пропорция карты
            el.style.transform = "translate(-50%, -50%)";

            el.innerHTML = `
                <img src="${card.img}">
                <div class="layout-card-label">${card.name}</div>
            `;
            container.appendChild(el);
        });
    }

    function retry() {
        isPaused = false;
        video.play();
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'flex';
        loop();
    }
</script>
</body>
</html>
