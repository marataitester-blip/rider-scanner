<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIDER: SAHI SCANNER</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/ort.min.js"></script>
    <style>
        /* === БАЗА === */
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', serif; user-select: none; }
        #app { position: relative; width: 100vw; height: 100vh; background: #000; }
        
        /* === ВИДЕО И ПРЕВЬЮ === */
        #video-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; display: flex; justify-content: center; align-items: center;
            background: #000; transition: opacity 0.5s;
        }
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        #preview-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* === ВИРТУАЛЬНЫЙ СТОЛ === */
        #virtual-table {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000000 100%);
            z-index: 10; display: none; perspective: 1000px;
        }

        /* === UI === */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
        }

        #top-bar {
            width: 100%; padding: 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: flex-start;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
        }

        #live-counter {
            color: #00ffea; /* Циан для отличия SAHI версии */
            font-size: 14px; font-weight: bold;
            background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 20px;
            border: 1px solid rgba(0, 255, 234, 0.3); letter-spacing: 1px; pointer-events: auto;
        }

        #reset-btn {
            padding: 10px 20px; border: 1px solid #ffd700; color: #ffd700;
            background: rgba(0,0,0,0.8); border-radius: 20px;
            pointer-events: auto; cursor: pointer; display: none;
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
        }

        #bottom-bar { padding-bottom: 40px; pointer-events: auto; }

        #action-btn {
            width: 80px; height: 80px;
            border-radius: 50%; border: 4px solid #00ffea; /* Циан */
            background: rgba(0,0,0,0.3);
            box-shadow: 0 0 25px rgba(0, 255, 234, 0.4);
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }
        #action-btn:active { transform: scale(0.9); background: rgba(0, 255, 234, 0.8); }
        /* Иконка "Сетка" для SAHI */
        #action-btn::after {
            content: ''; width: 40%; height: 40%; 
            border: 2px solid #00ffea; display: grid;
            background: 
                linear-gradient(#00ffea 0 0) center/100% 2px no-repeat,
                linear-gradient(#00ffea 0 0) center/2px 100% no-repeat;
        }

        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ffea; background: rgba(0,0,0,0.9); padding: 15px 30px; border-radius: 10px;
            border: 1px solid #00ffea; z-index: 30; font-size: 14px; display: block;
            pointer-events: auto; text-align: center;
        }

        /* === 3D КАРТА === */
        .digital-card {
            position: absolute; transform-style: preserve-3d;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: zoom-in;
        }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            text-align: center; transition: transform 0.8s; transform-style: preserve-3d;
        }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 6px; box-shadow: 0 10px 20px rgba(0,0,0,0.8);
            border: 1px solid #cfaa48; background-size: cover; background-position: center;
        }
        .card-back { background-image: url('./cards/rubashka.png'); background-color: #222; transform: rotateY(0deg); }
        .card-front { transform: rotateY(180deg); background-color: #000; }
        .digital-card.flipped .card-inner { transform: rotateY(180deg); }
        .card-label {
            position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%) rotateY(180deg);
            color: #ffd700; font-size: 11px; white-space: nowrap; text-shadow: 0 2px 2px #000;
            background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 4px;
            opacity: 0; transition: opacity 0.5s 0.5s;
        }
        .digital-card.flipped .card-label { opacity: 1; }

        /* === ZOOM === */
        #zoom-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            display: none; opacity: 0; transition: opacity 0.3s;
            flex-direction: column; justify-content: center; align-items: center; pointer-events: auto;
        }
        #zoom-overlay.active { display: flex; opacity: 1; }
        #zoomed-card-img {
            max-width: 90%; max-height: 80%; border-radius: 10px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3); border: 2px solid #ffd700;
            transform: scale(0.9); transition: transform 0.3s;
        }
        #zoom-overlay.active #zoomed-card-img { transform: scale(1); }
        #zoomed-title { margin-top: 20px; color: #ffd700; font-size: 24px; font-weight: bold; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="app">
    <div id="loader">Загрузка SAHI...</div>
    
    <div id="video-container">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="preview-canvas"></canvas>
    </div>
    
    <div id="virtual-table"></div>

    <div id="ui-layer">
        <div id="top-bar">
            <div id="live-counter">Режим: SAHI (Сетка)</div>
            <button id="reset-btn" onclick="resetScanner()">Новый скан</button>
        </div>
        <div id="bottom-bar">
            <div id="action-btn" onclick="performSAHIScan()"></div>
        </div>
    </div>

    <div id="zoom-overlay" onclick="closeZoom()">
        <img id="zoomed-card-img" src="" alt="Zoomed Card">
        <div id="zoomed-title"></div>
    </div>
</div>

<script>
    // === 1. НАСТРОЙКИ SAHI ===
    const CONFIG = {
        model: './rider_gold_800.onnx',
        size: 800,
        conf: 0.35,
        iou: 0.45,
        repo: "./cards/",
        liveInterval: 500, // В превью сканируем реже, так как превью - это ОБЫЧНЫЙ режим
        // Параметры нарезки (SAHI)
        sahiOverlap: 0.25  // 25% нахлест между кусками
    };

    const FILE_NAMES=["00-TheFool.jpg","01-TheMagician.jpg","02-TheHighPriestess.jpg","03-TheEmpress.jpg","04-TheEmperor.jpg","05-TheHierophant.jpg","06-TheLovers.jpg","07-TheChariot.jpg","08-Strength.jpg","09-TheHermit.jpg","10-WheelOfFortune.jpg","11-Justice.jpg","12-TheHangedMan.jpg","13-Death.jpg","14-Temperance.jpg","15-TheDevil.jpg","16-TheTower.jpg","17-TheStar.jpg","18-TheMoon.jpg","19-TheSun.jpg","20-Judgement.jpg","21-TheWorld.jpg","Wands01.jpg","Wands02.jpg","Wands03.jpg","Wands04.jpg","Wands05.jpg","Wands06.jpg","Wands07.jpg","Wands08.jpg","Wands09.jpg","Wands10.jpg","Wands11.jpg","Wands12.jpg","Wands13.jpg","Wands14.jpg","Cups01.jpg","Cups02.jpg","Cups03.jpg","Cups04.jpg","Cups05.jpg","Cups06.jpg","Cups07.jpg","Cups08.jpg","Cups09.jpg","Cups10.jpg","Cups11.jpg","Cups12.jpg","Cups13.jpg","Cups14.jpg","Swords01.jpg","Swords02.jpg","Swords03.jpg","Swords04.jpg","Swords05.jpg","Swords06.jpg","Swords07.jpg","Swords08.jpg","Swords09.jpg","Swords10.jpg","Swords11.jpg","Swords12.jpg","Swords13.jpg","Swords14.jpg","Pentacles01.jpg","Pentacles02.jpg","Pentacles03.jpg","Pentacles04.jpg","Pentacles05.jpg","Pentacles06.jpg","Pentacles07.jpg","Pentacles08.jpg","Pentacles09.jpg","Pentacles10.jpg","Pentacles11.jpg","Pentacles12.jpg","Pentacles13.jpg","Pentacles14.jpg"];
    const RU_NAMES=["Шут","Маг","Жрица","Императрица","Император","Жрец","Влюбленные","Колесница","Сила","Отшельник","Колесо Фортуны","Справедливость","Повешенный","Смерть","Умеренность","Дьявол","Башня","Звезда","Луна","Солнце","Суд","Мир","Туз Жезлов","2 Жезлов","3 Жезлов","4 Жезлов","5 Жезлов","6 Жезлов","7 Жезлов","8 Жезлов","9 Жезлов","10 Жезлов","Паж Жезлов","Рыцарь Жезлов","Королева Жезлов","Король Жезлов","Туз Кубков","2 Кубков","3 Кубков","4 Кубков","5 Кубков","6 Кубков","7 Кубков","8 Кубков","9 Кубков","10 Кубков","Паж Кубков","Рыцарь Кубков","Королева Кубков","Король Кубков","Туз Мечей","2 Мечей","3 Мечей","4 Мечей","5 Мечей","6 Мечей","7 Мечей","8 Мечей","9 Мечей","10 Мечей","Паж Мечей","Рыцарь Мечей","Королева Мечей","Король Мечей","Туз Пентаклей","2 Мечей","3 Пентаклей","4 Пентаклей","5 Пентаклей","6 Пентаклей","7 Пентаклей","8 Пентаклей","9 Пентаклей","10 Пентаклей","Паж Пентаклей","Рыцарь Пентаклей","Королева Пентаклей","Король Пентаклей"];

    let session;
    let isLiveMode = false;
    let lastDetectionTime = 0;
    
    const video = document.getElementById('video');
    const videoContainer = document.getElementById('video-container');
    const previewCanvas = document.getElementById('preview-canvas');
    const previewCtx = previewCanvas.getContext('2d');
    
    const table = document.getElementById('virtual-table');
    const loader = document.getElementById('loader');
    const actionBtn = document.getElementById('action-btn');
    const resetBtn = document.getElementById('reset-btn');
    const liveCounter = document.getElementById('live-counter');
    
    const zoomOverlay = document.getElementById('zoom-overlay');
    const zoomedImg = document.getElementById('zoomed-card-img');
    const zoomedTitle = document.getElementById('zoomed-title');

    const tensorCanvas = document.createElement('canvas');
    tensorCanvas.width = CONFIG.size; tensorCanvas.height = CONFIG.size;
    const tensorCtx = tensorCanvas.getContext('2d', {willReadFrequently: true});

    // === ИНИЦИАЛИЗАЦИЯ ===
    async function init() {
        try {
            ort.env.wasm.wasmPaths = "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/";
            session = await ort.InferenceSession.create(CONFIG.model, { executionProviders: ['wasm'] });
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                resizePreviewCanvas();
                loader.style.display = 'none';
                startLiveMode();
            };
        } catch(e) { loader.innerText = "Ошибка: " + e.message; }
    }
    window.onload = init;
    window.addEventListener('resize', resizePreviewCanvas);
    function resizePreviewCanvas() { previewCanvas.width = window.innerWidth; previewCanvas.height = window.innerHeight; }

    function startLiveMode() {
        isLiveMode = true;
        liveCounter.innerText = "SAHI готов. Наведи и нажми.";
        actionBtn.style.display = 'flex';
        resetBtn.style.display = 'none';
        videoContainer.style.opacity = 1;
        table.style.display = 'none';
        requestAnimationFrame(liveLoop);
    }

    // === LIVE PREVIEW (ОБЫЧНЫЙ РЕЖИМ, НЕ SAHI) ===
    // Для превью мы не используем SAHI (слишком тяжело), мы используем быстрый скан всего кадра.
    async function liveLoop() {
        if (!isLiveMode) return;
        const now = Date.now();
        if (now - lastDetectionTime > CONFIG.liveInterval) {
            lastDetectionTime = now;
            try {
                // Быстрый скан всего кадра
                const { boxes, scaleInfo } = await runSingleInference(0, 0, video.videoWidth, video.videoHeight);
                drawLiveOverlay(boxes, scaleInfo);
                liveCounter.innerText = `Превью: ${boxes.length} карт`;
            } catch (e) {}
        }
        requestAnimationFrame(liveLoop);
    }

    function drawLiveOverlay(boxes, scaleInfo) {
        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        if (boxes.length === 0) return;
        previewCtx.strokeStyle = "rgba(0, 255, 234, 0.6)"; // Циан для SAHI
        previewCtx.lineWidth = 2;
        boxes.forEach(box => {
            const coords = transformCoordinates(box, scaleInfo.tx, scaleInfo.ty, scaleInfo.scaleModel, scaleInfo.vW, scaleInfo.vH);
            previewCtx.strokeRect(coords.x - coords.w / 2, coords.y - coords.h / 2, coords.w, coords.h);
        });
    }

    // === SAHI SCAN (МЕДЛЕННЫЙ, НО ТОЧНЫЙ) ===
    async function performSAHIScan() {
        if (!isLiveMode) return;
        isLiveMode = false;
        loader.innerText = "SAHI: НАРЕЗКА 2x2...";
        loader.style.display = 'block';
        actionBtn.style.display = 'none';
        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

        // Даем браузеру время отрисовать лоадер
        setTimeout(async () => {
            try {
                const vW = video.videoWidth;
                const vH = video.videoHeight;
                
                // === ЛОГИКА НАРЕЗКИ ===
                // Делим экран на 4 части с перекрытием
                const overlap = CONFIG.sahiOverlap;
                const sliceW = vW * (0.5 + overlap/2); 
                const sliceH = vH * (0.5 + overlap/2);
                
                // Координаты углов нарезки (x, y)
                const slices = [
                    { x: 0, y: 0 },                    // Левый верх
                    { x: vW - sliceW, y: 0 },          // Правый верх
                    { x: 0, y: vH - sliceH },          // Левый низ
                    { x: vW - sliceW, y: vH - sliceH } // Правый низ
                ];

                let allBoxes = [];

                // Прогоняем каждый кусок
                for (let i = 0; i < slices.length; i++) {
                    loader.innerText = `SAHI: СЕКТОР ${i+1}/4...`;
                    const slice = slices[i];
                    
                    // Инференс куска
                    const { boxes } = await runSingleInference(slice.x, slice.y, sliceW, sliceH);
                    
                    // Пересчет координат из "Куска" в "Полный кадр"
                    // В runSingleInference мы получили координаты 0..800.
                    // Нужно:
                    // 1. Вернуть их в размер куска (sliceW/sliceH)
                    // 2. Добавить смещение куска (slice.x, slice.y)
                    
                    const scaleBack = Math.min(CONFIG.size/sliceW, CONFIG.size/sliceH);
                    const tx = (CONFIG.size - sliceW*scaleBack)/2;
                    const ty = (CONFIG.size - sliceH*scaleBack)/2;

                    boxes.forEach(b => {
                        // Восстанавливаем реальные координаты на видео
                        const realX = (b.x - tx) / scaleBack + slice.x;
                        const realY = (b.y - ty) / scaleBack + slice.y;
                        const realW = b.w / scaleBack;
                        const realH = b.h / scaleBack;

                        allBoxes.push({
                            x: realX, y: realY, w: realW, h: realH,
                            score: b.score, cls: b.cls
                        });
                    });
                }

                // Объединяем результаты (Глобальный NMS)
                // Так как карта может попасть в два куска сразу
                loader.innerText = "СБОРКА...";
                const finalBoxes = globalNMS(allBoxes);

                // Финал
                loader.style.display = 'none';
                if (finalBoxes.length === 0) {
                    alert("SAHI ничего не нашел.");
                    resetScanner(); return;
                }

                videoContainer.style.opacity = 0;
                table.style.display = 'block';
                resetBtn.style.display = 'block';
                liveCounter.innerText = `SAHI нашел: ${finalBoxes.length}`;

                // Рисуем (передаем уже глобальные координаты, поэтому scale=1)
                renderVirtualCardsFromGlobal(finalBoxes, vW, vH);

            } catch(e) {
                console.error(e);
                alert("Ошибка SAHI");
                resetScanner();
            }
        }, 50);
    }

    // Базовая функция инференса (для куска или целого)
    async function runSingleInference(sx, sy, sw, sh) {
        // Рисуем часть видео (sx, sy, sw, sh) в 800x800 с сохранением пропорций (Letterbox)
        const scale = Math.min(CONFIG.size/sw, CONFIG.size/sh);
        const tx = (CONFIG.size - sw*scale)/2;
        const ty = (CONFIG.size - sh*scale)/2;

        tensorCtx.fillStyle = "#000"; tensorCtx.fillRect(0,0,CONFIG.size,CONFIG.size);
        // drawImage(source, sx, sy, sw, sh, dx, dy, dw, dh)
        tensorCtx.drawImage(video, sx, sy, sw, sh, tx, ty, sw*scale, sh*scale);

        const imgData = tensorCtx.getImageData(0,0,CONFIG.size,CONFIG.size).data;
        const float32 = new Float32Array(3*CONFIG.size*CONFIG.size);
        for(let i=0; i<CONFIG.size**2; i++) {
            float32[i] = imgData[i*4]/255.0; 
            float32[CONFIG.size**2+i] = imgData[i*4+1]/255.0; 
            float32[2*CONFIG.size**2+i] = imgData[i*4+2]/255.0;
        }
        const tensor = new ort.Tensor('float32', float32, [1, 3, CONFIG.size, CONFIG.size]);
        const res = await session.run({[session.inputNames[0]]: tensor});
        const boxes = nms(parseYOLOv8(res[session.outputNames[0]])); // Локальный NMS

        return { boxes, scaleInfo: { tx, ty, scaleModel: scale, vW: sw, vH: sh } };
    }

    // === КООРДИНАТЫ И РЕНДЕР ===
    // Для обычного превью
    function transformCoordinates(box, tx, ty, scaleModel, vW, vH) {
        const screenW = window.innerWidth, screenH = window.innerHeight;
        const scaleScreen = Math.max(screenW / vW, screenH / vH);
        const offsetX = (screenW - vW * scaleScreen) / 2;
        const offsetY = (screenH - vH * scaleScreen) / 2;

        const realX = (box.x - tx) / scaleModel;
        const realY = (box.y - ty) / scaleModel;
        
        return {
            x: offsetX + realX * scaleScreen,
            y: offsetY + realY * scaleScreen,
            w: (box.w / scaleModel) * scaleScreen,
            h: (box.h / scaleModel) * scaleScreen
        };
    }

    // Для SAHI (когда у нас уже есть глобальные координаты на видео)
    function renderVirtualCardsFromGlobal(boxes, vW, vH) {
        table.innerHTML = '';
        const screenW = window.innerWidth, screenH = window.innerHeight;
        const scaleScreen = Math.max(screenW / vW, screenH / vH);
        const offsetX = (screenW - vW * scaleScreen) / 2;
        const offsetY = (screenH - vH * scaleScreen) / 2;

        boxes.forEach((box, index) => {
            // box.x/y/w/h уже в координатах оригинального видео (1920x1080)
            const finalX = offsetX + box.x * scaleScreen;
            const finalY = offsetY + box.y * scaleScreen;
            const finalW = box.w * scaleScreen;
            const finalH = box.h * scaleScreen;
            
            const cardImgUrl = CONFIG.repo + FILE_NAMES[box.cls];
            const cardName = RU_NAMES[box.cls];

            const container = document.createElement('div');
            container.className = 'digital-card';
            container.style.width = `${finalW}px`;
            container.style.height = `${finalH}px`;
            container.style.left = `${finalX - finalW/2}px`;
            container.style.top = `${finalY - finalH/2}px`;

            container.onclick = () => { showZoom(cardImgUrl, cardName); };

            const inner = document.createElement('div'); inner.className = 'card-inner';
            const back = document.createElement('div'); back.className = 'card-back';
            const front = document.createElement('div'); front.className = 'card-front';
            front.style.backgroundImage = `url('${cardImgUrl}')`;
            
            const label = document.createElement('div'); label.className = 'card-label';
            label.innerText = cardName;
            front.appendChild(label);

            inner.appendChild(front); inner.appendChild(back);
            container.appendChild(inner); table.appendChild(container);

            setTimeout(() => { container.classList.add('flipped'); }, 500 + (index * 150));
        });
    }

    // === ГЛОБАЛЬНЫЙ NMS (ДЛЯ СКЛЕЙКИ КУСКОВ) ===
    function globalNMS(boxes) {
        if (!boxes.length) return [];
        boxes.sort((a,b) => b.score - a.score);
        const res = [];
        while(boxes.length) {
            const best = boxes.shift();
            res.push(best);
            boxes = boxes.filter(b => {
                // IOU calc
                const x1 = Math.max(best.x - best.w/2, b.x - b.w/2);
                const y1 = Math.max(best.y - best.h/2, b.y - b.h/2);
                const x2 = Math.min(best.x + best.w/2, b.x + b.w/2);
                const y2 = Math.min(best.y + best.h/2, b.y + b.h/2);
                const interW = Math.max(0, x2 - x1);
                const interH = Math.max(0, y2 - y1);
                const interArea = interW * interH;
                const unionArea = (best.w * best.h) + (b.w * b.h) - interArea;
                return (interArea / unionArea) < CONFIG.iou;
            });
        }
        return res;
    }

    // === UI ===
    function showZoom(imgSrc, title) { zoomedImg.src = imgSrc; zoomedTitle.innerText = title; zoomOverlay.classList.add('active'); }
    function closeZoom() { zoomOverlay.classList.remove('active'); }
    function resetScanner() { closeZoom(); startLiveMode(); }

    // === YOLO CORE ===
    function parseYOLOv8(output) {
        const dims = output.dims; const data = output.data;
        const numAnchors = dims[2]; const numClasses = dims[1] - 4;
        const boxes = [];
        for (let i = 0; i < numAnchors; i++) {
            let maxScore = 0; let cls = -1;
            for (let c = 0; c < numClasses; c++) {
                const val = data[(c+4)*numAnchors + i];
                if (val > maxScore) { maxScore = val; cls = c; }
            }
            if (maxScore > CONFIG.conf) {
                boxes.push({ x: data[0*numAnchors+i], y: data[1*numAnchors+i], w: data[2*numAnchors+i], h: data[3*numAnchors+i], score: maxScore, cls: cls });
            }
        }
        return boxes;
    }
    function nms(boxes) { return globalNMS(boxes); } // Используем ту же функцию
</script>
</body>
</html>
