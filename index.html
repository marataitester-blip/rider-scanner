<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA ZERO: STABLE</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.1/dist/ort.min.js"></script>
    <style>
        :root { --neon: #00ffea; --gold: #ffd700; }
        body { margin: 0; background: #000; color: var(--neon); font-family: monospace; overflow: hidden; }
        #loader { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #scanner-ui { position: absolute; inset: 0; z-index: 10; display: none; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; inset: 0; pointer-events: none; }
        #status { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 20px; border: 1px solid var(--neon); border-radius: 5px; z-index: 20; width: 80%; text-align: center; }
        #scan-btn { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--neon); background: rgba(0,255,234,0.1); z-index: 30; cursor: pointer; }
        #scan-btn.ready { border-color: var(--gold); box-shadow: 0 0 20px var(--gold); }
    </style>
</head>
<body>

<div id="loader">
    <div style="font-size: 24px; letter-spacing: 5px; margin-bottom: 20px;">AURA AI ZERO</div>
    <div id="msg">ПРОВЕРКА СИСТЕМ...</div>
</div>

<div id="scanner-ui">
    <div id="status">ИНИЦИАЛИЗАЦИЯ...</div>
    <video id="camera" playsinline muted autoplay></video>
    <canvas id="overlay"></canvas>
    <div id="scan-btn" onclick="finalize()"></div>
</div>

<script>
const NAMES = ["00-TheFool","01-TheMagician","02-TheHighPriestess","03-TheEmpress","04-TheEmperor","05-TheHierophant","06-TheLovers","07-TheChariot","08-Strength","09-TheHermit","10-WheelOfFortune","11-Justice","12-TheHangedMan","13-Death","14-Temperance","15-TheDevil","16-TheTower","17-TheStar","18-TheMoon","19-TheSun","20-Judgement","21-TheWorld","CardBacks","Cups01","Cups02","Cups03","Cups04","Cups05","Cups06","Cups07","Cups08","Cups09","Cups10","Cups11","Cups12","Cups13","Cups14","Pentacles01","Pentacles02","Pentacles03","Pentacles04","Pentacles05","Pentacles06","Pentacles07","Pentacles08","Pentacles09","Pentacles10","Pentacles11","Pentacles12","Pentacles13","Pentacles14","Swords01","Swords02","Swords03","Swords04","Swords05","Swords06","Swords07","Swords08","Swords09","Swords10","Swords11","Swords12","Swords13","Swords14","Wands01","Wands02","Wands03","Wands04","Wands05","Wands06","Wands07","Wands08","Wands09","Wands10","Wands11","Wands12","Wands13","Wands14"];

let session, video, canvas, ctx;
let locked = []; 
let buffer = {};

async function init() {
    const msg = document.getElementById('msg');
    try {
        // 1. Проверка SharedArrayBuffer (защита от "undefined")
        if (typeof SharedArrayBuffer === 'undefined') {
            throw new Error("Блокировка браузера: Не найден SharedArrayBuffer. Проверь vercel.json и HTTPS.");
        }

        msg.innerText = "ЗАГРУЗКА НЕЙРОСЕТИ (6MB)...";
        ort.env.wasm.numThreads = 1; // Ограничиваем для стабильности на мобильных
        
        // Прямой путь к модели
        session = await ort.InferenceSession.create('./tarot_best.onnx', { 
            executionProviders: ['wasm'],
            graphOptimizationLevel: 'all'
        });

        msg.innerText = "ДОСТУП К КАМЕРЕ...";
        video = document.getElementById('camera');
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment', width: { ideal: 1280 } } 
        });
        video.srcObject = stream;

        video.onloadedmetadata = () => {
            canvas = document.getElementById('overlay');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx = canvas.getContext('2d');
            
            document.getElementById('loader').style.display = 'none';
            document.getElementById('scanner-ui').style.display = 'block';
            loop();
        };

    } catch (e) {
        // Выводим полную ошибку, а не только message
        msg.innerHTML = `<span style="color:#ff4444">КРИТИЧЕСКАЯ ОШИБКА:<br>${e.message || e || "Неизвестный сбой"}</span>`;
        console.error("Full Error Object:", e);
    }
}

async function loop() {
    if (document.getElementById('scanner-ui').style.display === 'none') return;

    // Подготовка кадра (YOLOv11 Nano 640x640)
    const off = document.createElement('canvas');
    off.width = off.height = 640;
    const oCtx = off.getContext('2d');
    oCtx.drawImage(video, 0, 0, 640, 640);
    const data = oCtx.getImageData(0, 0, 640, 640).data;
    
    const input = new Float32Array(3 * 640 * 640);
    for (let i = 0; i < 640 * 640; i++) {
        input[i] = data[i * 4] / 255;
        input[i + 640 * 640] = data[i * 4 + 1] / 255;
        input[i + 2 * 640 * 640] = data[i * 4 + 2] / 255;
    }

    const tensor = new ort.Tensor('float32', input, [1, 3, 640, 640]);
    const results = await session.run({ [session.inputNames[0]]: tensor });
    const output = results[session.outputNames[0]];

    process(output);
    requestAnimationFrame(loop);
}

function process(output) {
    const d = output.data;
    const anchors = output.dims[2]; // Должно быть 8400
    let found = [];

    for (let i = 0; i < anchors; i++) {
        let max = 0, cls = -1;
        for (let c = 0; c < 79; c++) {
            let s = d[(c + 4) * anchors + i];
            if (s > max) { max = s; cls = c; }
        }
        if (max > 0.5) {
            found.push({
                x: d[0 * anchors + i] * (canvas.width / 640),
                y: d[1 * anchors + i] * (canvas.height / 640),
                w: d[2 * anchors + i] * (canvas.width / 640),
                h: d[3 * anchors + i] * (canvas.height / 640),
                cls: cls
            });
        }
    }

    // Алгоритм AURA-LOCK (Неон -> Золото)
    found.forEach(box => {
        let id = `${box.cls}_${Math.round(box.x/40)}`;
        if (locked.some(l => l.id === id)) return;
        if (!buffer[id]) buffer[id] = { ...box, id, count: 0 };
        buffer[id].count++;
        if (buffer[id].count > 15) { // 15 кадров стабильности
            locked.push(buffer[id]);
            if (navigator.vibrate) navigator.vibrate(50);
            delete buffer[id];
        }
    });

    render(found);
}

function render(found) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Рисуем Gold (Locked)
    locked.forEach(c => {
        ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 4;
        ctx.strokeRect(c.x - c.w/2, c.y - c.h/2, c.w, c.h);
    });

    // Рисуем Neon (Active)
    found.forEach(b => {
        ctx.strokeStyle = '#00ffea'; ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(b.x - b.w/2, b.y - b.h/2, b.w, b.h);
        ctx.setLineDash([]);
    });

    document.getElementById('status').innerText = `КАРТ ЗАХВАЧЕНО: ${locked.length} / 11`;
    if (locked.length > 0) document.getElementById('scan-btn').classList.add('ready');
}

function finalize() {
    alert("Расклад из " + locked.length + " карт зафиксирован и передан.");
    // Здесь будет переход на виртуальный стол
}

window.onload = init;
</script>
</body>
</html>
