<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA AI ZERO</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.20.1/dist/ort.min.js"></script>
    <style>
        :root { --gold: #d4af37; --neon: #00ffea; --bg: #050505; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï */
        #scanner-view { position: fixed; inset: 0; display: flex; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.7); }
        canvas { position: absolute; inset: 0; z-index: 5; }
        
        .overlay-ui { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .top-bar { background: rgba(0,0,0,0.85); padding: 20px; text-align: center; border-bottom: 1px solid var(--gold); font-size: 13px; letter-spacing: 3px; color: var(--gold); text-transform: uppercase; }
        .bottom-bar { padding: 40px; display: flex; justify-content: center; pointer-events: auto; background: linear-gradient(transparent, rgba(0,0,0,0.9)); }
        
        #scan-btn { width: 75px; height: 75px; border-radius: 50%; border: 1px solid var(--gold); background: rgba(212, 175, 55, 0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 28px; transition: all 0.4s; }
        #scan-btn.ready { background: var(--gold); color: black; box-shadow: 0 0 30px var(--gold); transform: scale(1.1); }

        /* –í–ò–†–¢–£–ê–õ–¨–ù–´–ô –°–¢–û–õ */
        #table-view { position: fixed; inset: 0; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); display: none; flex-direction: column; padding: 20px; overflow-y: auto; z-index: 20; }
        .cards-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 30px; }
        .card-slot { width: 110px; text-align: center; animation: cardIn 0.6s ease forwards; }
        .card-img { width: 100%; border-radius: 6px; border: 1px solid var(--gold); box-shadow: 0 10px 20px rgba(0,0,0,0.6); }
        .card-label { font-size: 11px; margin-top: 10px; color: #fff; opacity: 0.8; letter-spacing: 1px; }

        @keyframes cardIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="scanner-view">
    <div class="overlay-ui">
        <div class="top-bar" id="status">AURA: –ü–û–ò–°–ö –ö–ê–†–¢ [0/11]</div>
        <div class="bottom-bar">
            <div id="scan-btn" onclick="goToTable()">üëÅÔ∏è</div>
        </div>
    </div>
    <video id="v" playsinline muted autoplay></video>
    <canvas id="c"></canvas>
</div>

<div id="table-view">
    <h2 style="text-align: center; color: var(--gold); font-weight: 300; letter-spacing: 5px; margin-top: 40px;">–†–ê–°–ö–õ–ê–î –¢–ê–†–û</h2>
    <div class="cards-grid" id="grid"></div>
    <button onclick="location.reload()" style="margin: 50px auto; display: block; background: none; border: 1px solid var(--gold); color: var(--gold); padding: 12px 30px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px;">–ù–æ–≤—ã–π —Å–µ–∞–Ω—Å</button>
</div>

<script>
const NAMES = ["00-TheFool","01-TheMagician","02-TheHighPriestess","03-TheEmpress","04-TheEmperor","05-TheHierophant","06-TheLovers","07-TheChariot","08-Strength","09-TheHermit","10-WheelOfFortune","11-Justice","12-TheHangedMan","13-Death","14-Temperance","15-TheDevil","16-TheTower","17-TheStar","18-TheMoon","19-TheSun","20-Judgement","21-TheWorld","CardBacks","Cups01","Cups02","Cups03","Cups04","Cups05","Cups06","Cups07","Cups08","Cups09","Cups10","Cups11","Cups12","Cups13","Cups14","Pentacles01","Pentacles02","Pentacles03","Pentacles04","Pentacles05","Pentacles06","Pentacles07","Pentacles08","Pentacles09","Pentacles10","Pentacles11","Pentacles12","Pentacles13","Pentacles14","Swords01","Swords02","Swords03","Swords04","Swords05","Swords06","Swords07","Swords08","Swords09","Swords10","Swords11","Swords12","Swords13","Swords14","Wands01","Wands02","Wands03","Wands04","Wands05","Wands06","Wands07","Wands08","Wands09","Wands10","Wands11","Wands12","Wands13","Wands14"];

const NAMES_RU = ["–®—É—Ç", "–ú–∞–≥", "–ñ—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä", "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç", "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ", "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞", "–°–∏–ª–∞", "–û—Ç—à–µ–ª—å–Ω–∏–∫", "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å", "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", "–°–º–µ—Ä—Ç—å", "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–î—å—è–≤–æ–ª", "–ë–∞—à–Ω—è", "–ó–≤–µ–∑–¥–∞", "–õ—É–Ω–∞", "–°–æ–ª–Ω—Ü–µ", "–°—É–¥", "–ú–∏—Ä", "–†—É–±–∞—à–∫–∞", "–¢—É–∑ –ö—É–±–∫–æ–≤", "2 –ö—É–±–∫–æ–≤", "3 –ö—É–±–∫–æ–≤", "4 –ö—É–±–∫–æ–≤", "5 –ö—É–±–∫–æ–≤", "6 –ö—É–±–∫–æ–≤", "7 –ö—É–±–∫–æ–≤", "8 –ö—É–±–∫–æ–≤", "9 –ö—É–±–∫–æ–≤", "10 –ö—É–±–∫–æ–≤", "–ü–∞–∂ –ö—É–±–∫–æ–≤", "–†—ã—Ü–∞—Ä—å –ö—É–±–∫–æ–≤", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ö—É–±–∫–æ–≤", "–ö–æ—Ä–æ–ª—å –ö—É–±–∫–æ–≤", "–¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "2 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "3 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "4 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "5 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "6 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "7 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "8 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "9 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "10 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ü–∞–∂ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–†—ã—Ü–∞—Ä—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ö–æ—Ä–æ–ª—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–¢—É–∑ –ú–µ—á–µ–π", "2 –ú–µ—á–µ–π", "3 –ú–µ—á–µ–π", "4 –ú–µ—á–µ–π", "5 –ú–µ—á–µ–π", "6 –ú–µ—á–µ–π", "7 –ú–µ—á–µ–π", "8 –ú–µ—á–µ–π", "9 –ú–µ—á–µ–π", "10 –ú–µ—á–µ–π", "–ü–∞–∂ –ú–µ—á–µ–π", "–†—ã—Ü–∞—Ä—å –ú–µ—á–µ–π", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ú–µ—á–µ–π", "–ö–æ—Ä–æ–ª—å –ú–µ—á–µ–π", "–¢—É–∑ –ñ–µ–∑–ª–æ–≤", "2 –ñ–µ–∑–ª–æ–≤", "3 –ñ–µ–∑–ª–æ–≤", "4 –ñ–µ–∑–ª–æ–≤", "5 –ñ–µ–∑–ª–æ–≤", "6 –ñ–µ–∑–ª–æ–≤", "7 –ñ–µ–∑–ª–æ–≤", "8 –ñ–µ–∑–ª–æ–≤", "9 –ñ–µ–∑–ª–æ–≤", "10 –ñ–µ–∑–ª–æ–≤", "–ü–∞–∂ –ñ–µ–∑–ª–æ–≤", "–†—ã—Ü–∞—Ä—å –ñ–µ–∑–ª–æ–≤", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ñ–µ–∑–ª–æ–≤", "–ö–æ—Ä–æ–ª—å –ñ–µ–∑–ª–æ–≤"];

let session, video, canvas, ctx;
let locked = new Map(); 
let buffer = new Map(); 

async function init() {
    ort.env.wasm.numThreads = 1;
    ort.env.wasm.proxy = true;
    try {
        const res = await fetch('tarot_best.onnx');
        const buf = await res.arrayBuffer();
        session = await ort.InferenceSession.create(buf, { executionProviders: ['wasm'] });
        video = document.getElementById('v');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 } } });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            canvas = document.getElementById('c');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx = canvas.getContext('2d');
            loop();
        };
    } catch (e) { console.error("–û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏:", e); }
}

async function loop() {
    if (document.getElementById('scanner-view').style.display === 'none') return;
    const off = document.createElement('canvas'); off.width = off.height = 640;
    const oCtx = off.getContext('2d'); oCtx.drawImage(video, 0, 0, 640, 640);
    const data = oCtx.getImageData(0,0,640,640).data;
    const input = new Float32Array(3 * 640 * 640);
    for (let i=0; i<640*640; i++) {
        input[i] = data[i*4]/255;
        input[i+640*640] = data[i*4+1]/255;
        input[i+2*640*640] = data[i*4+2]/255;
    }
    try {
        const tensor = new ort.Tensor('float32', input, [1, 3, 640, 640]);
        const results = await session.run({ [session.inputNames[0]]: tensor });
        process(results[session.outputNames[0]].data);
    } catch (e) { console.error(e); }
    requestAnimationFrame(loop);
}

function process(data) {
    const anchors = 8400;
    const sx = canvas.width / 640;
    const sy = canvas.height / 640;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let frameItems = [];

    for (let i=0; i<anchors; i++) {
        let conf = 0, cls = -1;
        for (let c=4; c<83; c++) { if (data[c*anchors+i] > conf) { conf = data[c*anchors+i]; cls = c-4; } }
        if (conf > 0.60) {
            frameItems.push({ cls, x: data[0*anchors+i]*sx, y: data[1*anchors+i]*sy, w: data[2*anchors+i]*sx, h: data[3*anchors+i]*sy });
        }
    }

    frameItems.forEach(item => {
        if (locked.has(item.cls)) return;
        let b = buffer.get(item.cls) || { count: 0 };
        b.count++;
        buffer.set(item.cls, b);
        if (b.count > 12) {
            locked.set(item.cls, item);
            if (navigator.vibrate) navigator.vibrate(40);
            buffer.delete(item.cls);
        }
        ctx.strokeStyle = "#00ffea"; ctx.lineWidth = 1; ctx.setLineDash([4, 4]);
        ctx.strokeRect(item.x-item.w/2, item.y-item.h/2, item.w, item.h);
    });

    locked.forEach((item, cls) => {
        ctx.strokeStyle = "#d4af37"; ctx.setLineDash([]); ctx.lineWidth = 1.5;
        ctx.strokeRect(item.x-item.w/2, item.y-item.h/2, item.w, item.h);
        ctx.fillStyle = "#d4af37"; ctx.font = "10px sans-serif";
        ctx.fillText(NAMES_RU[cls], item.x-item.w/2, item.y-item.h/2 - 8);
    });

    document.getElementById('status').innerText = `–ó–ê–•–í–ê–ß–ï–ù–û: ${locked.size} / 11`;
    if (locked.size > 0) document.getElementById('scan-btn').classList.add('ready');
}

function goToTable() {
    if (locked.size === 0) return;
    const sorted = Array.from(locked.values()).sort((a, b) => a.x - b.x);
    const grid = document.getElementById('grid');
    grid.innerHTML = "";

    sorted.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card-slot';
        
        // –ü–†–ò–û–†–ò–¢–ï–¢: –í–Ω–µ—à–Ω–∏–π –Ω–∞–¥–µ–∂–Ω—ã–π —Ä–µ—Å—É—Ä—Å
        const imgUrl = `https://cdn.jsdelivr.net/gh/marataitester-blip/rider-tarot-card@main/Cards-jpg/Cards-jpg/${NAMES[item.cls]}.jpg`;
        
        div.innerHTML = `
            <img src="${imgUrl}" class="card-img" onerror="this.src='https://via.placeholder.com/110x170/222/d4af37?text=...'">
            <div class="card-label">${NAMES_RU[item.cls]}</div>
        `;
        grid.appendChild(div);
    });

    document.getElementById('scanner-view').style.display = 'none';
    document.getElementById('table-view').style.display = 'flex';
}

window.onload = init;
</script>
</body>
</html>
