<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA AI: MASTER DIAGNOSTIC</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.20.1/dist/ort.min.js"></script>
    <style>
        :root { --gold: #d4af37; --neon: #00ffea; --bg: #050505; }
        body { margin: 0; background: var(--bg); color: white; font-family: monospace; overflow: hidden; }
        
        /* –°–ö–ê–ù–ï–† */
        #scanner-view { position: fixed; inset: 0; display: flex; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.7); }
        canvas { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
        
        /* –ú–û–ù–ò–¢–û–† –ü–ê–†–ê–ú–ï–¢–†–û–í */
        #perf-panel { 
            position: absolute; top: 90px; left: 15px; z-index: 20; 
            background: rgba(0,0,0,0.8); padding: 12px; border-left: 2px solid var(--neon);
            font-size: 11px; color: var(--neon); pointer-events: none; border-radius: 0 4px 4px 0;
        }

        .ui { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .status { background: rgba(0,0,0,0.85); padding: 20px; text-align: center; border-bottom: 1px solid var(--gold); font-size: 13px; letter-spacing: 2px; color: var(--gold); text-transform: uppercase; }
        
        .controls { padding: 40px; display: flex; justify-content: center; gap: 20px; pointer-events: auto; background: linear-gradient(transparent, rgba(0,0,0,0.9)); }
        .btn { display: none; width: 180px; height: 50px; border-radius: 25px; border: 1px solid var(--gold); background: rgba(212, 175, 55, 0.1); cursor: pointer; align-items: center; justify-content: center; font-size: 14px; color: var(--gold); font-weight: bold; transition: 0.3s; }
        .btn.active { background: var(--gold); color: black; box-shadow: 0 0 25px var(--gold); }
        #go-btn { width: 65px; border-radius: 50%; font-size: 24px; }

        /* –ò–î–ï–ê–õ–¨–ù–´–ô –í–ò–†–¢–£–ê–õ–¨–ù–´–ô –°–¢–û–õ */
        #table-view { position: fixed; inset: 0; background: radial-gradient(#1a1a1a, #000); display: none; z-index: 50; flex-direction: column; }
        #grid-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); 
            gap: 15px; padding: 30px; 
            width: 100%; max-width: 900px; margin: auto;
            align-content: center;
        }
        .card-slot { text-align: center; animation: fadeIn 0.6s ease forwards; cursor: pointer; }
        .card-img { width: 100%; border-radius: 6px; border: 1px solid var(--gold); box-shadow: 0 8px 20px rgba(0,0,0,0.8); }
        .card-label { font-size: 10px; color: var(--gold); margin-top: 10px; text-transform: uppercase; opacity: 0.8; }

        /* –ó–£–ú –ü–†–ò –ù–ê–ñ–ê–¢–ò–ò */
        #zoom-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; padding: 20px; }
        #zoom-img { max-height: 70vh; border: 1px solid var(--gold); border-radius: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<div id="scanner-view">
    <div id="perf-panel">
        –ò–ù–§–ï–†–ï–ù–°: <span id="inf-ms">0</span> ms<br>
        –ü–û–¢–û–ö: <span id="fps-val">0</span> FPS<br>
        –ü–û–†–û–ì: 0.55
    </div>
    <div class="ui">
        <div class="status" id="st">–û–ñ–ò–î–ê–ù–ò–ï –ö–ê–ú–ï–†–´...</div>
        <div class="controls">
            <div id="start-btn" class="btn" onclick="toggleScan()">–ù–∞—á–∞—Ç—å –∑–∞—Ö–≤–∞—Ç</div>
            <div id="go-btn" class="btn" onclick="goToTable()" style="display:none">üëÅÔ∏è</div>
        </div>
    </div>
    <video id="v" playsinline muted autoplay></video>
    <canvas id="c"></canvas>
</div>

<div id="table-view">
    <div id="grid-container"></div>
    <div style="padding: 30px; text-align: center;">
        <button onclick="location.reload()" style="background: none; border: 1px solid var(--gold); color: var(--gold); padding: 12px 30px; cursor: pointer; text-transform: uppercase; font-size: 11px;">–°–±—Ä–æ—Å —Å–∏—Å—Ç–µ–º—ã</button>
    </div>
</div>

<div id="zoom-overlay" onclick="this.style.display='none'">
    <img id="zoom-img" src="">
    <h3 id="zoom-name" style="color: var(--gold); margin-top: 20px; font-weight: 300; letter-spacing: 2px;"></h3>
    <p style="color: #666; font-size: 12px;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞</p>
</div>

<script>
const NAMES = ["00-TheFool","01-TheMagician","02-TheHighPriestess","03-TheEmpress","04-TheEmperor","05-TheHierophant","06-TheLovers","07-TheChariot","08-Strength","09-TheHermit","10-WheelOfFortune","11-Justice","12-TheHangedMan","13-Death","14-Temperance","15-TheDevil","16-TheTower","17-TheStar","18-TheMoon","19-TheSun","20-Judgement","21-TheWorld","CardBacks","Cups01","Cups02","Cups03","Cups04","Cups05","Cups06","Cups07","Cups08","Cups09","Cups10","Cups11","Cups12","Cups13","Cups14","Pentacles01","Pentacles02","Pentacles03","Pentacles04","Pentacles05","Pentacles06","Pentacles07","Pentacles08","Pentacles09","Pentacles10","Pentacles11","Pentacles12","Pentacles13","Pentacles14","Swords01","Swords02","Swords03","Swords04","Swords05","Swords06","Swords07","Swords08","Swords09","Swords10","Swords11","Swords12","Swords13","Swords14","Wands01","Wands02","Wands03","Wands04","Wands05","Wands06","Wands07","Wands08","Wands09","Wands10","Wands11","Wands12","Wands13","Wands14"];
const NAMES_RU = ["–®—É—Ç", "–ú–∞–≥", "–ñ—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä", "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç", "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ", "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞", "–°–∏–ª–∞", "–û—Ç—à–µ–ª—å–Ω–∏–∫", "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å", "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", "–°–º–µ—Ä—Ç—å", "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–î—å—è–≤–æ–ª", "–ë–∞—à–Ω—è", "–ó–≤–µ–∑–¥–∞", "–õ—É–Ω–∞", "–°–æ–ª–Ω—Ü–µ", "–°—É–¥", "–ú–∏—Ä", "–†—É–±–∞—à–∫–∞", "–¢—É–∑ –ö—É–±–∫–æ–≤", "2 –ö—É–±–∫–æ–≤", "3 –ö—É–±–∫–æ–≤", "4 –ö—É–±–∫–æ–≤", "5 –ö—É–±–∫–æ–≤", "6 –ö—É–±–∫–æ–≤", "7 –ö—É–±–∫–æ–≤", "8 –ö—É–±–∫–æ–≤", "9 –ö—É–±–∫–æ–≤", "10 –ö—É–±–∫–æ–≤", "–ü–∞–∂ –ö—É–±–∫–æ–≤", "–†—ã—Ü–∞—Ä—å –ö—É–±–∫–æ–≤", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ö—É–±–∫–æ–≤", "–ö–æ—Ä–æ–ª—å –ö—É–±–∫–æ–≤", "–¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "2 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "3 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "4 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "5 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "6 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "7 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "8 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "9 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "10 –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ü–∞–∂ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–†—ã—Ü–∞—Ä—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ö–æ—Ä–æ–ª—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–¢—É–∑ –ú–µ—á–µ–π", "2 –ú–µ—á–µ–π", "3 –ú–µ—á–µ–π", "4 –ú–µ—á–µ–π", "5 –ú–µ—á–µ–π", "6 –ú–µ—á–µ–π", "7 –ú–µ—á–µ–π", "8 –ú–µ—á–µ–π", "9 –ú–µ—á–µ–π", "10 –ú–µ—á–µ–π", "–ü–∞–∂ –ú–µ—á–µ–π", "–†—ã—Ü–∞—Ä—å –ú–µ—á–µ–π", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ú–µ—á–µ–π", "–ö–æ—Ä–æ–ª—å –ú–µ—á–µ–π", "–¢—É–∑ –ñ–µ–∑–ª–æ–≤", "2 –ñ–µ–∑–ª–æ–≤", "3 –ñ–µ–∑–ª–æ–≤", "4 –ñ–µ–∑–ª–æ–≤", "5 –ñ–µ–∑–ª–æ–≤", "6 –ñ–µ–∑–ª–æ–≤", "7 –ñ–µ–∑–ª–æ–≤", "8 –ñ–µ–∑–ª–æ–≤", "9 –ñ–µ–∑–ª–æ–≤", "10 –ñ–µ–∑–ª–æ–≤", "–ü–∞–∂ –ñ–µ–∑–ª–æ–≤", "–†—ã—Ü–∞—Ä—å –ñ–µ–∑–ª–æ–≤", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ñ–µ–∑–ª–æ–≤", "–ö–æ—Ä–æ–ª—å –ñ–µ–∑–ª–æ–≤"];

let session, video, canvas, ctx, isScanning = false;
let locked = new Map(), buffer = new Map();
let lastTime = performance.now(), frameCount = 0;

async function init() {
    try {
        ort.env.wasm.numThreads = 1;
        ort.env.wasm.proxy = true;
        const res = await fetch('tarot_best.onnx');
        const buf = await res.arrayBuffer();
        session = await ort.InferenceSession.create(buf, { executionProviders: ['wasm'] });
        
        video = document.getElementById('v');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            canvas = document.getElementById('c');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx = canvas.getContext('2d');
            document.getElementById('st').innerText = "–ê–£–†–ê: –û–ñ–ò–î–ê–ù–ò–ï –ó–ê–•–í–ê–¢–ê";
            document.getElementById('start-btn').style.display = 'flex';
            loop();
        };
    } catch (e) { document.getElementById('st').innerText = "–û–®–ò–ë–ö–ê: " + e; }
}

function toggleScan() {
    isScanning = !isScanning;
    const btn = document.getElementById('start-btn');
    btn.innerText = isScanning ? "–ü–ê–£–ó–ê" : "–ü–†–û–î–û–õ–ñ–ò–¢–¨";
    btn.classList.toggle('active', isScanning);
    if(isScanning) document.getElementById('go-btn').style.display = 'flex';
}

async function loop() {
    if (document.getElementById('scanner-view').style.display === 'none') return;
    
    // FPS Monitor
    frameCount++;
    const now = performance.now();
    if (now - lastTime >= 1000) {
        document.getElementById('fps-val').innerText = frameCount;
        frameCount = 0; lastTime = now;
    }

    if (!isScanning) {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        drawLocked(); requestAnimationFrame(loop); return;
    }

    const startInf = performance.now();
    const off = document.createElement('canvas'); off.width = off.height = 640;
    const oCtx = off.getContext('2d'); oCtx.drawImage(video, 0, 0, 640, 640);
    const pix = oCtx.getImageData(0,0,640,640).data;
    const input = new Float32Array(3 * 640 * 640);
    for (let i=0; i<640*640; i++) {
        input[i] = pix[i*4]/255;
        input[i+640*640] = pix[i*4+1]/255;
        input[i+2*640*640] = pix[i*4+2]/255;
    }

    try {
        const tensor = new ort.Tensor('float32', input, [1, 3, 640, 640]);
        const res = await session.run({ [session.inputNames[0]]: tensor });
        document.getElementById('inf-ms').innerText = (performance.now() - startInf).toFixed(1);
        process(res[session.outputNames[0]].data);
    } catch (e) { console.error(e); }
    
    requestAnimationFrame(loop);
}

function process(data) {
    const anchors = 8400;
    const sx = canvas.width / 640, sy = canvas.height / 640;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    for (let i=0; i<anchors; i++) {
        let conf = 0, cls = -1;
        for (let c=4; c<83; c++) {
            if (data[c*anchors+i] > conf) { conf = data[c*anchors+i]; cls = c-4; }
        }
        
        // –ü–û–†–û–ì 0.55 –î–õ–Ø –ß–ò–°–¢–û–¢–´
        if (conf > 0.55) {
            const x = data[0*anchors+i]*sx, y = data[1*anchors+i]*sy;
            const w = data[2*anchors+i]*sx, h = data[3*anchors+i]*sy;

            if (!locked.has(cls)) {
                let b = buffer.get(cls) || { count: 0 };
                b.count++; buffer.set(cls, b);
                if (b.count > 12) { 
                    locked.set(cls, { x, y, name: NAMES_RU[cls], file: NAMES[cls], w, h });
                    if (navigator.vibrate) navigator.vibrate(40);
                }
                ctx.strokeStyle = "#00ffea"; ctx.lineWidth = 1; ctx.setLineDash([5,5]);
                ctx.strokeRect(x-w/2, y-h/2, w, h);
                ctx.fillStyle = "#00ffea"; ctx.font = "10px monospace";
                ctx.fillText(`${(conf*100).toFixed(1)}%`, x-w/2, y-h/2-5);
            }
        }
    }
    drawLocked();
    document.getElementById('st').innerText = `–ó–ê–•–í–ê–ß–ï–ù–û: ${locked.size} / 11`;
}

function drawLocked() {
    locked.forEach((item) => {
        ctx.strokeStyle = "#d4af37"; ctx.lineWidth = 1; ctx.setLineDash([]);
        ctx.strokeRect(item.x-item.w/2, item.y-item.h/2, item.w, item.h);
        ctx.fillStyle = "#d4af37"; ctx.font = "bold 10px sans-serif";
        ctx.fillText(item.name, item.x-item.w/2, item.y-item.h/2-8);
    });
}

function goToTable() {
    if (locked.size === 0) return;
    isScanning = false;
    const grid = document.getElementById('grid-container');
    grid.innerHTML = "";
    
    // –ò–î–ï–ê–õ–¨–ù–ê–Ø –°–ï–¢–ö–ê: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
    const sorted = Array.from(locked.values()).sort((a, b) => {
        if (Math.abs(a.y - b.y) > 100) return a.y - b.y;
        return a.x - b.x;
    });

    sorted.forEach((card) => {
        const div = document.createElement('div');
        div.className = 'card-slot';
        div.onclick = () => {
            document.getElementById('zoom-img').src = `/cards/${card.file}.jpg`;
            document.getElementById('zoom-name').innerText = card.name;
            document.getElementById('zoom-overlay').style.display = 'flex';
        };
        div.innerHTML = `
            <img src="/cards/${card.file}.jpg" class="card-img" onerror="this.src='https://via.placeholder.com/100x150?text=CARD'">
            <div class="card-label">${card.name}</div>
        `;
        grid.appendChild(div);
    });

    document.getElementById('scanner-view').style.display = 'none';
    document.getElementById('table-view').style.display = 'flex';
}

window.onload = init;
</script>
</body>
</html>
