<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA AI: DIAGNOSTIC V2</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.20.1/dist/ort.min.js"></script>
    <style>
        :root { --gold: #d4af37; --neon: #00ffea; --bg: #050505; }
        body { margin: 0; background: var(--bg); color: white; font-family: monospace; overflow: hidden; }
        
        /* СКАНИРОВАНИЕ */
        #scanner-view { position: fixed; inset: 0; display: flex; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.6); }
        canvas { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
        
        /* ДИАГНОСТИКА */
        #perf-monitor { 
            position: absolute; top: 80px; left: 10px; z-index: 20; 
            background: rgba(0,0,0,0.7); padding: 10px; border-left: 2px solid var(--neon);
            font-size: 10px; line-height: 1.4; color: var(--neon); pointer-events: none;
        }

        .ui { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .status { background: rgba(0,0,0,0.85); padding: 20px; text-align: center; border-bottom: 1px solid var(--gold); font-size: 13px; letter-spacing: 2px; color: var(--gold); }
        .controls { padding: 40px; display: flex; justify-content: center; gap: 20px; pointer-events: auto; }
        .btn { width: 180px; height: 50px; border-radius: 25px; border: 1px solid var(--gold); background: rgba(212, 175, 55, 0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--gold); text-transform: uppercase; font-weight: bold; }
        .btn.active { background: var(--gold); color: black; box-shadow: 0 0 20px var(--gold); }
    </style>
</head>
<body>

<div id="scanner-view">
    <div id="perf-monitor">
        ИНФЕРЕНС: <span id="inf-time">0</span> ms<br>
        ПОТОК: <span id="fps">0</span> FPS<br>
        ЯДРО: ORT 1.20.1 (WASM)
    </div>
    <div class="ui">
        <div class="status" id="st">ИНИЦИАЛИЗАЦИЯ...</div>
        <div class="controls">
            <div id="start-btn" class="btn" onclick="toggleScan()" style="display:none">Начать тест</div>
        </div>
    </div>
    <video id="v" playsinline muted autoplay></video>
    <canvas id="c"></canvas>
</div>

<script>
const NAMES_RU = ["Шут", "Маг", "Жрица", "Императрица", "Император", "Иерофант", "Влюбленные", "Колесница", "Сила", "Отшельник", "Колесо Фортуны", "Справедливость", "Повешенный", "Смерть", "Умеренность", "Дьявол", "Башня", "Звезда", "Луна", "Солнце", "Суд", "Мир", "Рубашка", "Туз Кубков", "2 Кубков", "3 Кубков", "4 Кубков", "5 Кубков", "6 Кубков", "7 Кубков", "8 Кубков", "9 Кубков", "10 Кубков", "Паж Кубков", "Рыцарь Кубков", "Королева Кубков", "Король Кубков", "Туз Пентаклей", "2 Пентаклей", "3 Пентаклей", "4 Пентаклей", "5 Пентаклей", "6 Пентаклей", "7 Пентаклей", "8 Пентаклей", "9 Пентаклей", "10 Пентаклей", "Паж Пентаклей", "Рыцарь Пентаклей", "Королева Пентаклей", "Король Пентаклей", "Туз Мечей", "2 Мечей", "3 Мечей", "4 Мечей", "5 Мечей", "6 Мечей", "7 Мечей", "8 Мечей", "9 Мечей", "10 Мечей", "Паж Мечей", "Рыцарь Мечей", "Королева Мечей", "Король Мечей", "Туз Жезлов", "2 Жезлов", "3 Жезлов", "4 Жезлов", "5 Жезлов", "6 Жезлов", "7 Жезлов", "8 Жезлов", "9 Жезлов", "10 Жезлов", "Паж Жезлов", "Рыцарь Жезлов", "Королева Жезлов", "Король Жезлов"];

let session, video, canvas, ctx, isScanning = false;
let lastTime = 0, frameCount = 0, fps = 0;

async function init() {
    try {
        ort.env.wasm.numThreads = 1;
        ort.env.wasm.proxy = true;
        const res = await fetch('tarot_best.onnx');
        const buf = await res.arrayBuffer();
        session = await ort.InferenceSession.create(buf, { executionProviders: ['wasm'] });
        
        video = document.getElementById('v');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            canvas = document.getElementById('c');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx = canvas.getContext('2d');
            document.getElementById('start-btn').style.display = 'flex';
            document.getElementById('st').innerText = "ТЕСТОВАЯ СРЕДА ГОТОВА";
            loop();
        };
    } catch (e) { alert(e); }
}

function toggleScan() {
    isScanning = !isScanning;
    document.getElementById('start-btn').classList.toggle('active');
    document.getElementById('start-btn').innerText = isScanning ? "СТОП" : "НАЧАТЬ ТЕСТ";
}

async function loop() {
    const now = performance.now();
    frameCount++;
    if (now - lastTime >= 1000) {
        fps = frameCount;
        document.getElementById('fps').innerText = fps;
        frameCount = 0;
        lastTime = now;
    }

    if (isScanning) {
        const startInf = performance.now();
        
        const off = document.createElement('canvas'); off.width = off.height = 640;
        const oCtx = off.getContext('2d'); oCtx.drawImage(video, 0, 0, 640, 640);
        const pix = oCtx.getImageData(0,0,640,640).data;
        const input = new Float32Array(3 * 640 * 640);
        for (let i=0; i<640*640; i++) {
            input[i] = pix[i*4]/255;
            input[i+640*640] = pix[i*4+1]/255;
            input[i+2*640*640] = pix[i*4+2]/255;
        }

        const tensor = new ort.Tensor('float32', input, [1, 3, 640, 640]);
        const results = await session.run({ [session.inputNames[0]]: tensor });
        
        const endInf = performance.now();
        document.getElementById('inf-time').innerText = (endInf - startInf).toFixed(1);
        
        process(results[session.outputNames[0]].data);
    } else {
        ctx.clearRect(0,0,canvas.width,canvas.height);
    }
    requestAnimationFrame(loop);
}

function process(data) {
    const anchors = 8400;
    const sx = canvas.width / 640, sy = canvas.height / 640;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    for (let i=0; i<anchors; i++) {
        let conf = 0, cls = -1;
        for (let c=4; c<83; c++) {
            if (data[c*anchors+i] > conf) { conf = data[c*anchors+i]; cls = c-4; }
        }
        
        // Порог 0.55 для чистоты эксперимента
        if (conf > 0.55) {
            const x = data[0*anchors+i]*sx, y = data[1*anchors+i]*sy;
            const w = data[2*anchors+i]*sx, h = data[3*anchors+i]*sy;

            ctx.strokeStyle = "#00ffea"; ctx.lineWidth = 1;
            ctx.strokeRect(x-w/2, y-h/2, w, h);
            
            // ВЫВОД ТОЧНОГО ПРОЦЕНТА
            ctx.fillStyle = "#00ffea"; ctx.font = "12px monospace";
            const label = `${NAMES_RU[cls]} ${(conf * 100).toFixed(1)}%`;
            ctx.fillText(label, x-w/2, y-h/2-5);
        }
    }
}

window.onload = init;
</script>
</body>
</html>
