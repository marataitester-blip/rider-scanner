<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA ZERO: IRON STABLE</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.1/dist/ort.min.js"></script>
    <style>
        :root { --gold: #d4af37; --neon: #00ffea; }
        body { margin: 0; background: #000; color: var(--gold); font-family: 'Courier New', monospace; overflow: hidden; }
        #loader { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #log-area { font-size: 10px; color: #444; margin-top: 20px; text-align: left; max-width: 320px; border-top: 1px solid #222; padding-top: 10px; }
        #ui { position: absolute; inset: 0; z-index: 10; display: none; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        canvas { position: absolute; inset: 0; pointer-events: none; }
        #status { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 20px; border: 1px solid var(--gold); border-radius: 5px; z-index: 20; width: 80%; text-align: center; }
        #btn { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--gold); background: rgba(212, 175, 55, 0.1); z-index: 30; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 30px; }
    </style>
</head>
<body>

<div id="loader">
    <div style="font-size: 24px; letter-spacing: 5px; color: var(--gold);">AURA SYSTEM</div>
    <div id="msg" style="margin-top:20px;">–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø...</div>
    <div id="log-area"></div>
</div>

<div id="ui">
    <div id="status">–ü–û–ò–°–ö –ö–ê–†–¢...</div>
    <video id="v" playsinline muted autoplay></video>
    <canvas id="c"></canvas>
    <div id="btn" onclick="finalize()">üëÅÔ∏è</div>
</div>

<script>
// –¢–≤–æ–π –º–∞—Å—Å–∏–≤ –∏–∑ 79 –∏–º–µ–Ω (—Å—Ç—Ä–æ–≥–æ –ø–æ–¥ tarot_best.onnx)
const NAMES = ["00-TheFool","01-TheMagician","02-TheHighPriestess","03-TheEmpress","04-TheEmperor","05-TheHierophant","06-TheLovers","07-TheChariot","08-Strength","09-TheHermit","10-WheelOfFortune","11-Justice","12-TheHangedMan","13-Death","14-Temperance","15-TheDevil","16-TheTower","17-TheStar","18-TheMoon","19-TheSun","20-Judgement","21-TheWorld","CardBacks","Cups01","Cups02","Cups03","Cups04","Cups05","Cups06","Cups07","Cups08","Cups09","Cups10","Cups11","Cups12","Cups13","Cups14","Pentacles01","Pentacles02","Pentacles03","Pentacles04","Pentacles05","Pentacles06","Pentacles07","Pentacles08","Pentacles09","Pentacles10","Pentacles11","Pentacles12","Pentacles13","Pentacles14","Swords01","Swords02","Swords03","Swords04","Swords05","Swords06","Swords07","Swords08","Swords09","Swords10","Swords11","Swords12","Swords13","Swords14","Wands01","Wands02","Wands03","Wands04","Wands05","Wands06","Wands07","Wands08","Wands09","Wands10","Wands11","Wands12","Wands13","Wands14"];

let session, video, canvas, ctx;
let locked = new Map(); // –•—Ä–∞–Ω–∏–º –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –ø–æ ID

function logger(t) { document.getElementById('log-area').innerText += "> " + t + "\n"; }

async function init() {
    const msg = document.getElementById('msg');
    try {
        logger("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Safe Mode...");
        // –û—Ç–∫–ª—é—á–∞–µ–º –í–°–Å, —á—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫–∏ 30540976 –∏ 30541768
        ort.env.wasm.numThreads = 1;
        ort.env.wasm.simd = false;
        ort.env.wasm.proxy = false;
        ort.env.wasm.wasmPaths = "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.1/dist/";

        logger("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ (10.7MB)...");
        const res = await fetch('tarot_best.onnx');
        if (!res.ok) throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!");
        const buffer = await res.arrayBuffer();
        
        logger("–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (–ë–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π)...");
        // graphOptimizationLevel: 'disabled' ‚Äî —ç—Ç–æ –ø—Ä—è–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Ç–≤–æ–µ–π –æ—à–∏–±–∫–∏
        session = await ort.InferenceSession.create(buffer, { 
            executionProviders: ['wasm'],
            graphOptimizationLevel: 'disabled',
            executionMode: 'sequential'
        });

        logger("–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...");
        video = document.getElementById('v');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            canvas = document.getElementById('c');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx = canvas.getContext('2d');
            document.getElementById('loader').style.display = 'none';
            document.getElementById('ui').style.display = 'flex';
            loop();
        };
    } catch (e) {
        msg.innerHTML = `<span style="color:red">–°–ë–û–ô:<br>${e.message || e}</span>`;
        logger("–û—à–∏–±–∫–∞: " + e);
    }
}

async function loop() {
    if (document.getElementById('ui').style.display === 'none') return;

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞–¥—Ä–∞ 640x640 (YOLOv11)
    const mat = document.createElement('canvas');
    mat.width = mat.height = 640;
    const mCtx = mat.getContext('2d');
    mCtx.drawImage(video, 0, 0, 640, 640);
    const imgData = mCtx.getImageData(0, 0, 640, 640).data;
    
    const input = new Float32Array(3 * 640 * 640);
    for (let i=0; i<640*640; i++) {
        input[i] = imgData[i*4]/255.0;
        input[640*640+i] = imgData[i*4+1]/255.0;
        input[2*640*640+i] = imgData[i*4+2]/255.0;
    }

    try {
        const tensor = new ort.Tensor('float32', input, [1, 3, 640, 640]);
        const out = await session.run({ [session.inputNames[0]]: tensor });
        process(out[session.outputNames[0]].data);
    } catch (e) { console.error(e); }
    
    requestAnimationFrame(loop);
}

function process(data) {
    const anchors = 8400; // YOLOv11 —Å—Ç–∞–Ω–¥–∞—Ä—Ç
    const sx = canvas.width / 640;
    const sy = canvas.height / 640;
    
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Map –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç (–∫–∞–∫ –≤ —Ç–≤–æ–µ–π –ê—É—Ä–µ 3)
    let frameSeen = new Set();

    for (let i=0; i<anchors; i++) {
        let conf = 0, cls = -1;
        // 79 –∫–ª–∞—Å—Å–æ–≤ (4 –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã + 79 –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π)
        for (let c=4; c<83; c++) {
            let s = data[c*anchors+i];
            if (s > conf) { conf = s; cls = c-4; }
        }

        if (conf > 0.50 && !frameSeen.has(cls)) {
            frameSeen.add(cls);
            
            const x = data[0*anchors+i] * sx;
            const y = data[1*anchors+i] * sy;
            const w = data[2*anchors+i] * sx;
            const h = data[3*anchors+i] * sy;

            // –ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞ –¥–ª—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö, –ù–µ–æ–Ω –¥–ª—è –Ω–æ–≤—ã—Ö
            if (locked.has(cls)) {
                ctx.strokeStyle = "#ffd700"; ctx.lineWidth = 4;
            } else {
                ctx.strokeStyle = "#00ffea"; ctx.lineWidth = 1;
                // –ê–≤—Ç–æ-—Ñ–∏–∫—Å–∞—Ü–∏—è (Aura-Lock)
                locked.set(cls, { name: NAMES[cls], x: x, y: y });
                if (navigator.vibrate) navigator.vibrate(40);
            }
            
            ctx.strokeRect(x-w/2, y-h/2, w, h);
            ctx.fillStyle = ctx.strokeStyle;
            ctx.font = "bold 16px Arial";
            ctx.fillText(NAMES[cls], x-w/2, y-h/2 - 10);
        }
    }

    document.getElementById('status').innerText = `–ó–ê–§–ò–ö–°–ò–†–û–í–ê–ù–û: ${locked.size} / 11`;
}

function finalize() {
    if (locked.size === 0) return;
    alert(`–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ ${locked.size} –∫–∞—Ä—Ç. –ü–µ—Ä–µ–¥–∞—é –ú–µ—Å—Å–∏—Ä—É –Ω–∞ –∞–Ω–∞–ª–∏–∑.`);
}

window.onload = init;
</script>
</body>
</html>
