<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA HYBRID: STABLE 11</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.1/dist/ort.min.js"></script>
    <style>
        :root { --neon: #d4af37; --bg: #000; }
        body { margin: 0; background: var(--bg); color: var(--neon); font-family: 'Roboto', sans-serif; overflow: hidden; }
        #loader { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; inset: 0; pointer-events: none; }
        #status { position: absolute; top: 20px; width: 100%; text-align: center; background: rgba(0,0,0,0.7); padding: 10px; z-index: 20; border-bottom: 1px solid var(--neon); }
    </style>
</head>
<body>

<div id="loader">
    <h1 style="letter-spacing: 5px;">AURA SYSTEM</h1>
    <div id="load-msg">ЗАГРУЗКА ИНТЕЛЛЕКТА...</div>
</div>

<div id="status">ОЖИДАНИЕ...</div>
<video id="v" playsinline muted autoplay></video>
<canvas id="c"></canvas>

<script>
// Твои настройки из Ауры 3 (работают как часики)
ort.env.wasm.numThreads = 1;
ort.env.wasm.simd = false;

const NAMES = ["00-TheFool","01-TheMagician","02-TheHighPriestess","03-TheEmpress","04-TheEmperor","05-TheHierophant","06-TheLovers","07-TheChariot","08-Strength","09-TheHermit","10-WheelOfFortune","11-Justice","12-TheHangedMan","13-Death","14-Temperance","15-TheDevil","16-TheTower","17-TheStar","18-TheMoon","19-TheSun","20-Judgement","21-TheWorld","CardBacks","Cups01","Cups02","Cups03","Cups04","Cups05","Cups06","Cups07","Cups08","Cups09","Cups10","Cups11","Cups12","Cups13","Cups14","Pentacles01","Pentacles02","Pentacles03","Pentacles04","Pentacles05","Pentacles06","Pentacles07","Pentacles08","Pentacles09","Pentacles10","Pentacles11","Pentacles12","Pentacles13","Pentacles14","Swords01","Swords02","Swords03","Swords04","Swords05","Swords06","Swords07","Swords08","Swords09","Swords10","Swords11","Swords12","Swords13","Swords14","Wands01","Wands02","Wands03","Wands04","Wands05","Wands06","Wands07","Wands08","Wands09","Wands10","Wands11","Wands12","Wands13","Wands14"];

let session, video, canvas, ctx;
let lockedCards = new Map(); // Используем Map для уникальности (как Set в Ауре 3)

async function init() {
    try {
        // Загрузка модели через ArrayBuffer (самый надежный способ из Ауры 3)
        const res = await fetch('tarot_best.onnx');
        const buffer = await res.arrayBuffer();
        session = await ort.InferenceSession.create(buffer, { executionProviders: ['wasm'] });

        video = document.getElementById('v');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            canvas = document.getElementById('c');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx = canvas.getContext('2d');
            document.getElementById('loader').style.display = 'none';
            loop();
        };
    } catch (e) {
        document.getElementById('load-msg').innerText = "ОШИБКА: " + e.message;
    }
}

async function loop() {
    const modelSize = 640;
    const mat = document.createElement('canvas');
    mat.width = mat.height = modelSize;
    mat.getContext('2d').drawImage(video, 0, 0, modelSize, modelSize);
    const data = mat.getContext('2d').getImageData(0,0,modelSize,modelSize).data;
    
    const input = new Float32Array(3 * 640 * 640);
    for (let i=0; i<640*640; i++) {
        input[i] = data[i*4]/255.0;
        input[640*640+i] = data[i*4+1]/255.0;
        input[2*640*640+i] = data[i*4+2]/255.0;
    }
    const tensor = new ort.Tensor('float32', input, [1, 3, 640, 640]);

    try {
        const results = await session.run({ [session.inputNames[0]]: tensor });
        process(results[session.outputNames[0]].data);
    } catch (e) { console.error(e); }
    
    requestAnimationFrame(loop);
}

function process(data) {
    const numAnchors = 8400;
    const sx = canvas.width/640;
    const sy = canvas.height/640;
    
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // Применяем логику "Уникальности" из Ауры 3
    let currentFrameIds = new Set();

    for (let i=0; i<numAnchors; i++) {
        let conf = 0, cls = 0;
        for(let c=4; c<83; c++) {
            if(data[c*numAnchors+i] > conf) { conf = data[c*numAnchors+i]; cls = c-4; }
        }

        if (conf > 0.55 && !currentFrameIds.has(cls)) {
            currentFrameIds.add(cls);
            
            const x = data[0*numAnchors+i] * sx;
            const y = data[1*numAnchors+i] * sy;
            const w = data[2*numAnchors+i] * sx;
            const h = data[3*numAnchors+i] * sy;

            // Рисуем рамку
            ctx.strokeStyle = "#d4af37";
            ctx.strokeRect(x-w/2, y-h/2, w, h);
            ctx.fillText(NAMES[cls], x-w/2, y-h/2 - 10);
            
            // Если карта видна стабильно, добавляем в "Золотой список"
            lockedCards.set(cls, {name: NAMES[cls], x: x, y: y});
        }
    }

    document.getElementById('status').innerText = `ЗАФИКСИРОВАНО КАРТ: ${lockedCards.size} / 11`;
}

window.onload = init;
</script>
</body>
</html>
